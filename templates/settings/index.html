{% extends "base.html" %}

{% block title %}Settings - Vertex AR Admin{% endblock %}
{% block page_title %}Settings{% endblock %}

{% block content %}
<div x-data="settingsPage()">
    <div class="max-w-4xl mx-auto">
        <form @submit.prevent="saveSettings" class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="site_title" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Site Title</label>
                    <input type="text" name="site_title" id="site_title" 
                           class="mt-1 block w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 py-2 px-3 shadow-sm focus:outline-none focus:ring-indigo-50 focus:border-indigo-500 sm:text-sm dark:text-white"
                           x-model="settings.site_title"
                           :value="settings.site_title">
                </div>
                
                <div>
                    <label for="admin_email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Admin Email</label>
                    <input type="email" name="admin_email" id="admin_email" 
                           class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 py-2 px-3 shadow-sm focus:outline-none focus:ring-indigo-50 focus:border-indigo-500 sm:text-sm dark:text-white"
                           x-model="settings.admin_email"
                           :value="settings.admin_email">
                </div>
                
                <div class="md:col-span-2">
                    <label for="site_description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Site Description</label>
                    <textarea name="site_description" id="site_description" rows="3"
                              class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 py-2 px-3 shadow-sm focus:outline-none focus:ring-indigo-50 focus:border-indigo-500 sm:text-sm dark:text-white"
                              x-model="settings.site_description">{{ settings.site_description }}</textarea>
                </div>
                
                <div>
                    <label for="password_min_length" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Minimum Password Length</label>
                    <input type="number" name="password_min_length" id="password_min_length" min="6" max="128"
                           class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 py-2 px-3 shadow-sm focus:outline-none focus:ring-indigo-50 focus:border-indigo-500 sm:text-sm dark:text-white"
                           x-model="settings.password_min_length"
                           :value="settings.password_min_length">
                </div>
                
                <div>
                    <label for="session_timeout" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Session Timeout (minutes)</label>
                    <input type="number" name="session_timeout" id="session_timeout" min="1" max="1440"
                           class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 py-2 px-3 shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:text-white"
                           x-model="settings.session_timeout"
                           :value="settings.session_timeout">
                </div>
                
                <div>
                    <label for="default_storage" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Default Storage Provider</label>
                    <select name="default_storage" id="default_storage" 
                            class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 py-2 px-3 shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:text-white"
                            x-model="settings.default_storage">
                        <option value="local">Local</option>
                        <option value="aws_s3">AWS S3</option>
                        <option value="minio">MinIO</option>
                        <option value="yandex_disk">Yandex Disk</option>
                    </select>
                </div>
                
                <div>
                    <label for="max_file_size" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Max File Size (MB)</label>
                    <input type="number" name="max_file_size" id="max_file_size" min="1" max="1000"
                           class="mt-1 block w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 py-2 px-3 shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:text-white"
                           x-model="settings.max_file_size"
                           :value="settings.max_file_size">
                </div>
                
                <div class="flex justify-end space-x-3 md:col-span-2">
                    <button type="button" @click="resetToDefaults" 
                            class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        Reset to Defaults
                    </button>
                    <button type="submit" 
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-60 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                            :disabled="!hasChanges"
                            :class="{'opacity-50 cursor-not-allowed': !hasChanges}">
                        Save Settings
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
function settingsPage() {
    return {
        settings: {
            site_title: '{{ settings.site_title if settings else "Vertex AR B2B Platform" }}',
            admin_email: '{{ settings.admin_email if settings else "admin@vertexar.com" }}',
            site_description: '{{ settings.site_description if settings else "B2B SaaS platform for creating AR content based on image recognition (NFT markers)" }}',
            password_min_length: parseInt('{{ settings.password_min_length if settings else 8 }}'),
            session_timeout: parseInt('{{ settings.session_timeout if settings else 60 }}'),
            default_storage: '{{ settings.default_storage if settings else "local" }}',
            max_file_size: parseInt('{{ settings.max_file_size if settings else 10 }}')
        },
        
        originalSettings: {},
        
        init() {
            // Store original settings for change detection
            this.originalSettings = { ...this.settings };
        },
        
        get hasChanges() {
            return JSON.stringify(this.settings) !== JSON.stringify(this.originalSettings);
        },
        
        saveSettings() {
            // Save settings using htmx
            htmx.ajax('POST', '/api/settings', {
                source: this.settings,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': 'token' // Add CSRF token if required
                }
            }).then(() => {
                showToast('Settings saved successfully', 'success');
                // Update original settings to current values
                this.originalSettings = { ...this.settings };
            }).catch(() => {
                showToast('Failed to save settings', 'error');
            });
        },
        
        resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to defaults?')) {
                this.settings = {
                    site_title: 'Vertex AR B2B Platform',
                    admin_email: 'admin@vertexar.com',
                    site_description: 'B2B SaaS platform for creating AR content based on image recognition (NFT markers)',
                    password_min_length: 8,
                    session_timeout: 60,
                    default_storage: 'local',
                    max_file_size: 10
                };
            }
        }
    };
}
</script>
{% endblock %}