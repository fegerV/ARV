{% extends "base.html" %}

{% block title %}Dashboard - Vertex AR Admin{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div x-data="dashboard()" x-init="loadData()">
    
    <!-- Error Alert -->
    <div x-show="error" 
         x-transition
         class="mb-6 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
        <div class="flex">
            <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
            <div>
                <h3 class="text-sm font-medium text-red-800 dark:text-red-200">Error</h3>
                <p class="mt-1 text-sm text-red-700 dark:text-red-300" x-text="error"></p>
            </div>
        </div>
    </div>
    
    <!-- Loading State -->
    <div x-show="loading" class="flex justify-center items-center h-64">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
    </div>
    
    <!-- Stats Cards -->
    <div x-show="!loading" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <template x-for="stat in stats" :key="stat.title">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400" x-text="stat.title"></p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white mt-2" x-text="stat.value"></p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" x-text="stat.change"></p>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas text-2xl" 
                           :class="stat.iconClass"
                           :style="`color: ${stat.color}`"></i>
                    </div>
                </div>
            </div>
        </template>
    </div>
    
    <!-- Recent Activity -->
    <div x-show="!loading" class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Recent Activity</h3>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                <template x-for="activity in recentActivity" :key="activity.id">
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center"
                                 :class="activity.iconBg">
                                <i class="fas text-xs" 
                                   :class="activity.iconClass"></i>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-gray-900 dark:text-white" x-text="activity.message"></p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" x-text="activity.time"></p>
                        </div>
                    </div>
                </template>
                
                <div x-show="recentActivity.length === 0" class="text-center py-8">
                    <i class="fas fa-inbox text-gray-400 text-3xl mb-3"></i>
                    <p class="text-gray-500 dark:text-gray-400">No recent activity</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div x-show="!loading" class="mt-8">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Quick Actions</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <a href="/admin/companies/new" 
               class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 hover:shadow-md transition-shadow">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                        <i class="fas fa-plus text-white"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">New Company</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Create a company</p>
                    </div>
                </div>
            </a>
            
            <a href="/admin/projects/new" 
               class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 hover:shadow-md transition-shadow">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                        <i class="fas fa-folder-plus text-white"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">New Project</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Start a project</p>
                    </div>
                </div>
            </a>
            
            <a href="/admin/ar-content/new" 
               class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 hover:shadow-md transition-shadow">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                        <i class="fas fa-cube text-white"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">New AR Content</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Upload content</p>
                    </div>
                </div>
            </a>
            
            <a href="/admin/analytics" 
               class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 hover:shadow-md transition-shadow">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-bar text-white"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">View Analytics</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">See metrics</p>
                    </div>
                </div>
            </a>
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function dashboard() {
    return {
        loading: true,
        error: null,
        stats: [
            {
                title: 'Total AR Views',
                value: '—',
                change: '',
                icon: 'fa-eye',
                iconClass: 'fas fa-eye',
                color: '#1976d2'
            },
            {
                title: 'Unique Sessions',
                value: '—',
                change: '',
                icon: 'fa-users',
                iconClass: 'fas fa-users',
                color: '#2e7d32'
            },
            {
                title: 'Active Content',
                value: '—',
                change: '',
                icon: 'fa-cube',
                iconClass: 'fas fa-cube',
                color: '#9c27b0'
            },
            {
                title: 'Storage Usage',
                value: '—',
                change: '',
                icon: 'fa-database',
                iconClass: 'fas fa-database',
                color: '#ed6c02'
            }
        ],
        recentActivity: [],
        
        async loadData() {
            this.loading = true;
            this.error = null;
            
            try {
                // Load analytics summary
                const response = await fetch('/api/analytics/summary', {
                    headers: {
                        'Authorization': `Bearer ${this.getAuthToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load dashboard data');
                }
                
                const data = await response.json();
                
                // Update stats
                this.stats[0].value = data.total_views?.toLocaleString() || '—';
                this.stats[1].value = data.unique_sessions?.toLocaleString() || '—';
                this.stats[2].value = data.active_content?.toLocaleString() || '—';
                this.stats[3].value = data.storage_used_gb ? `${data.storage_used_gb} GB` : '—';
                
                // Load recent activity (mock data for now)
                this.recentActivity = [
                    {
                        id: 1,
                        message: 'New AR content "Demo Marker" uploaded successfully',
                        time: '2 hours ago',
                        icon: 'fa-check-circle',
                        iconClass: 'fas fa-check-circle text-green-500',
                        iconBg: 'bg-green-100 dark:bg-green-900/20'
                    },
                    {
                        id: 2,
                        message: 'Company "Acme Corp" created',
                        time: '5 hours ago',
                        icon: 'fa-building',
                        iconClass: 'fas fa-building text-blue-500',
                        iconBg: 'bg-blue-100 dark:bg-blue-900/20'
                    },
                    {
                        id: 3,
                        message: 'Storage usage reached 85% capacity',
                        time: '1 day ago',
                        icon: 'fa-exclamation-triangle',
                        iconClass: 'fas fa-exclamation-triangle text-yellow-500',
                        iconBg: 'bg-yellow-100 dark:bg-yellow-900/20'
                    }
                ];
                
            } catch (error) {
                console.error('Dashboard error:', error);
                this.error = error.message;
                showToast('Failed to load dashboard data', 'error');
            } finally {
                this.loading = false;
            }
        },
        
        getAuthToken() {
            // Get auth token from cookies or local storage
            return document.cookie.split(';')
                .find(cookie => cookie.trim().startsWith('access_token='))
                ?.split('=')[1] || '';
        }
    };
}
</script>
{% endblock %}