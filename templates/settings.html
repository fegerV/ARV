{% extends "base.html" %}

{% block title %}Настройки - Vertex AR Admin{% endblock %}

{% block page_title %}Настройки{% endblock %}

{% block content %}
<div x-data="settingsPage()" class="max-w-5xl mx-auto px-4 sm:px-0">
    <!-- Уведомления -->
    {% if success_message %}
    <div class="mb-6 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl flex items-center gap-3">
        <span class="material-icons text-green-600 dark:text-green-400">check_circle</span>
        <span class="text-green-800 dark:text-green-200 text-sm">{{ success_message }}</span>
    </div>
    {% endif %}

    {% if error_message %}
    <div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl flex items-center gap-3">
        <span class="material-icons text-red-600 dark:text-red-400">error</span>
        <span class="text-red-800 dark:text-red-200 text-sm">{{ error_message }}</span>
    </div>
    {% endif %}

    <!-- Табы навигации (мобильные — горизонтальный скролл) -->
    <div class="flex gap-2 mb-6 overflow-x-auto pb-1 scrollbar-hide">
        <button @click="activeTab = 'general'"
                :class="activeTab === 'general'
                    ? 'bg-blue-600 text-white shadow-sm'
                    : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700'"
                class="flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium whitespace-nowrap transition-all">
            <span class="material-icons text-lg">settings</span>
            Основные
        </button>
        <button @click="activeTab = 'security'"
                :class="activeTab === 'security'
                    ? 'bg-blue-600 text-white shadow-sm'
                    : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700'"
                class="flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium whitespace-nowrap transition-all">
            <span class="material-icons text-lg">security</span>
            Безопасность
        </button>
        <button @click="activeTab = 'ar'"
                :class="activeTab === 'ar'
                    ? 'bg-blue-600 text-white shadow-sm'
                    : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700'"
                class="flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium whitespace-nowrap transition-all">
            <span class="material-icons text-lg">view_in_ar</span>
            AR-контент
        </button>
    </div>

    <!-- ===================== ОСНОВНЫЕ НАСТРОЙКИ ===================== -->
    <div x-show="activeTab === 'general'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-1" x-transition:enter-end="opacity-100 translate-y-0">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Основные настройки</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Название платформы, контакты и общие параметры</p>
            </div>

            <form method="post" action="/settings/general" class="p-6 space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                    <div>
                        <label for="site_title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Название платформы</label>
                        <input type="text" name="site_title" id="site_title"
                               value="{{ settings.general.site_title|default('Vertex AR B2B Platform') }}"
                               class="form-input" required>
                    </div>
                    <div>
                        <label for="admin_email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Email администратора</label>
                        <input type="email" name="admin_email" id="admin_email"
                               value="{{ settings.general.admin_email|default('admin@vertexar.com') }}"
                               class="form-input" required>
                    </div>
                </div>

                <div>
                    <label for="site_description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Описание платформы</label>
                    <textarea id="site_description" name="site_description" rows="2"
                              class="form-input">{{ settings.general.site_description|default('B2B SaaS платформа для создания AR-контента') }}</textarea>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-5">
                    <div>
                        <label for="timezone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Часовой пояс</label>
                        <select id="timezone" name="timezone" class="form-select">
                            <option value="UTC" {% if settings.general.timezone == 'UTC' %}selected{% endif %}>UTC</option>
                            <option value="Europe/Moscow" {% if settings.general.timezone == 'Europe/Moscow' %}selected{% endif %}>Москва (UTC+3)</option>
                            <option value="Europe/London" {% if settings.general.timezone == 'Europe/London' %}selected{% endif %}>Лондон (UTC+0)</option>
                            <option value="America/New_York" {% if settings.general.timezone == 'America/New_York' %}selected{% endif %}>Нью-Йорк (UTC-5)</option>
                        </select>
                    </div>
                    <div>
                        <label for="language" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Язык</label>
                        <select id="language" name="language" class="form-select">
                            <option value="ru" {% if settings.general.language == 'ru' %}selected{% endif %}>Русский</option>
                            <option value="en" {% if settings.general.language == 'en' %}selected{% endif %}>English</option>
                        </select>
                    </div>
                    <div>
                        <label for="default_subscription_years" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Срок подписки (лет)</label>
                        <input type="number" name="default_subscription_years" id="default_subscription_years"
                               value="{{ settings.general.default_subscription_years|default(1) }}"
                               min="1" max="10" class="form-input">
                    </div>
                </div>

                <div class="flex items-center gap-3 p-4 bg-amber-50 dark:bg-amber-900/20 rounded-xl border border-amber-200 dark:border-amber-800">
                    <input id="maintenance_mode" name="maintenance_mode" type="checkbox"
                           {% if settings.general.maintenance_mode %}checked{% endif %}
                           value="on"
                           class="h-4 w-4 text-amber-600 focus:ring-amber-500 border-gray-300 rounded">
                    <label for="maintenance_mode" class="text-sm">
                        <span class="font-medium text-gray-900 dark:text-white">Режим обслуживания</span>
                        <span class="text-gray-500 dark:text-gray-400 block text-xs mt-0.5">Временно закрыть публичный доступ к платформе</span>
                    </label>
                </div>

                <div class="flex flex-col sm:flex-row justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" onclick="window.location.reload()" class="btn btn-secondary w-full sm:w-auto">Отмена</button>
                    <button type="submit" class="btn btn-primary w-full sm:w-auto">
                        <span class="material-icons text-sm mr-1">save</span>Сохранить
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ===================== БЕЗОПАСНОСТЬ ===================== -->
    <div x-show="activeTab === 'security'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-1" x-transition:enter-end="opacity-100 translate-y-0">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Безопасность</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Политики паролей, сессий и ограничения доступа</p>
            </div>

            <form method="post" action="/settings/security" class="p-6 space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                    <div>
                        <label for="password_min_length" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Мин. длина пароля</label>
                        <input type="number" name="password_min_length" id="password_min_length"
                               value="{{ settings.security.password_min_length|default(8) }}"
                               min="6" max="50" class="form-input">
                    </div>
                    <div>
                        <label for="session_timeout" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Таймаут сессии (мин.)</label>
                        <input type="number" name="session_timeout" id="session_timeout"
                               value="{{ settings.security.session_timeout|default(60) }}"
                               min="5" max="1440" class="form-input">
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                    <div>
                        <label for="max_login_attempts" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Макс. попыток входа</label>
                        <input type="number" name="max_login_attempts" id="max_login_attempts"
                               value="{{ settings.security.max_login_attempts|default(5) }}"
                               min="3" max="20" class="form-input">
                    </div>
                    <div>
                        <label for="lockout_duration" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Блокировка (сек.)</label>
                        <input type="number" name="lockout_duration" id="lockout_duration"
                               value="{{ settings.security.lockout_duration|default(300) }}"
                               min="60" max="3600" class="form-input">
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">300 сек. = 5 мин.</p>
                    </div>
                </div>

                <div>
                    <label for="api_rate_limit" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Лимит API (запросов/мин.)</label>
                    <input type="number" name="api_rate_limit" id="api_rate_limit"
                           value="{{ settings.security.api_rate_limit|default(100) }}"
                           min="10" max="1000" class="form-input">
                </div>

                <div class="flex items-center gap-3 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-800">
                    <input id="require_2fa" name="require_2fa" type="checkbox"
                           {% if settings.security.require_2fa %}checked{% endif %}
                           value="on"
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="require_2fa" class="text-sm">
                        <span class="font-medium text-gray-900 dark:text-white">Двухфакторная аутентификация</span>
                        <span class="text-gray-500 dark:text-gray-400 block text-xs mt-0.5">Обязательная 2FA для всех администраторов</span>
                    </label>
                </div>

                <div class="flex flex-col sm:flex-row justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" onclick="window.location.reload()" class="btn btn-secondary w-full sm:w-auto">Отмена</button>
                    <button type="submit" class="btn btn-primary w-full sm:w-auto">
                        <span class="material-icons text-sm mr-1">save</span>Сохранить
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ===================== AR-КОНТЕНТ ===================== -->
    <div x-show="activeTab === 'ar'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-1" x-transition:enter-end="opacity-100 translate-y-0">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Настройки AR-контента</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Генерация маркеров, обработка видео и параметры QR-кодов</p>
            </div>

            <form method="post" action="/settings/ar" class="p-6 space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                    <div>
                        <label for="thumbnail_quality" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Качество превью (%)</label>
                        <input type="number" name="thumbnail_quality" id="thumbnail_quality"
                               value="{{ settings.ar.thumbnail_quality|default(80) }}"
                               min="10" max="100" step="5" class="form-input">
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">JPEG-качество генерируемых превью</p>
                    </div>
                    <div>
                        <label for="qr_code_expiration_days" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Срок действия QR (дней)</label>
                        <input type="number" name="qr_code_expiration_days" id="qr_code_expiration_days"
                               value="{{ settings.ar.qr_code_expiration_days|default(365) }}"
                               min="30" max="1825" class="form-input">
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">365 = 1 год, 1825 = 5 лет</p>
                    </div>
                </div>

                <div>
                    <label for="default_ar_viewer_theme" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Тема AR-просмотрщика</label>
                    <select id="default_ar_viewer_theme" name="default_ar_viewer_theme" class="form-select">
                        <option value="default" {% if settings.ar.default_ar_viewer_theme == 'default' %}selected{% endif %}>По умолчанию</option>
                        <option value="dark" {% if settings.ar.default_ar_viewer_theme == 'dark' %}selected{% endif %}>Тёмная</option>
                        <option value="minimal" {% if settings.ar.default_ar_viewer_theme == 'minimal' %}selected{% endif %}>Минималистичная</option>
                        <option value="corporate" {% if settings.ar.default_ar_viewer_theme == 'corporate' %}selected{% endif %}>Корпоративная</option>
                    </select>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="flex items-center gap-3 p-4 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-200 dark:border-green-800">
                        <input id="marker_generation_enabled" name="marker_generation_enabled" type="checkbox"
                               {% if settings.ar.marker_generation_enabled %}checked{% endif %}
                               value="on"
                               class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                        <label for="marker_generation_enabled" class="text-sm">
                            <span class="font-medium text-gray-900 dark:text-white">Генерация маркеров</span>
                            <span class="text-gray-500 dark:text-gray-400 block text-xs mt-0.5">Автоматическое создание AR-маркеров</span>
                        </label>
                    </div>
                    <div class="flex items-center gap-3 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-800">
                        <input id="video_processing_enabled" name="video_processing_enabled" type="checkbox"
                               {% if settings.ar.video_processing_enabled %}checked{% endif %}
                               value="on"
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="video_processing_enabled" class="text-sm">
                            <span class="font-medium text-gray-900 dark:text-white">Обработка видео</span>
                            <span class="text-gray-500 dark:text-gray-400 block text-xs mt-0.5">Фоновая оптимизация видеофайлов</span>
                        </label>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" onclick="window.location.reload()" class="btn btn-secondary w-full sm:w-auto">Отмена</button>
                    <button type="submit" class="btn btn-primary w-full sm:w-auto">
                        <span class="material-icons text-sm mr-1">save</span>Сохранить
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.scrollbar-hide::-webkit-scrollbar { display: none; }
.scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
</style>

<script>
function settingsPage() {
    return {
        activeTab: '{{ active_section|default("general") }}',
        init() {
            const hash = window.location.hash.substring(1);
            if (['general', 'security', 'ar'].includes(hash)) {
                this.activeTab = hash;
            }
            this.$watch('activeTab', (val) => {
                window.location.hash = val;
            });
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', function() {
                    const btn = this.querySelector('button[type="submit"]');
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = '<span class="material-icons text-sm mr-1 animate-spin">refresh</span>Сохранение...';
                    }
                });
            });
        }
    };
}
</script>
{% endblock %}
