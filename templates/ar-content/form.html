{% extends "base.html" %}

{% block title %}{% if ar_content and ar_content.id %}Edit AR Content - Vertex AR Admin{% else %}Create AR Content - Vertex AR Admin{% endif %}{% endblock %}
{% block page_title %}{% if ar_content and ar_content.id %}Edit AR Content{% else %}Create AR Content{% endif %}{% endblock %}

{% block content %}
<div x-data="{
    companies: {{ companies_js | tojson }},
    projects: [],
    selectedCompany: '{{ ar_content.company_id if ar_content and ar_content.company_id else '' }}',
    selectedProject: '{{ ar_content.project_id if ar_content and ar_content.project_id else '' }}',
    arContent: {{ ar_content|tojson if ar_content else 'null' }},
    loading: false,
    submitting: false,
    
    async loadProjects() {
        if (!this.selectedCompany) {
            this.projects = [];
            this.selectedProject = '';
            return;
        }
        
        this.loading = true;
        try {
            const response = await fetch(`/api/projects/by-company/${this.selectedCompany}`);
            if (response.ok) {
                const data = await response.json();
                this.projects = data.projects || [];
                // Сбросить выбранный проект, если он не принадлежит новой компании
                if (!this.projects.some(p => p.id == this.selectedProject)) {
                    this.selectedProject = '';
                }
            } else {
                console.error('Ошибка загрузки проектов:', response.statusText);
                this.projects = [];
                this.selectedProject = '';
            }
        } catch (error) {
            console.error('Ошибка при загрузке проектов:', error);
            this.projects = [];
            this.selectedProject = '';
        } finally {
            this.loading = false;
        }
    },
    
    get isValid() {
        // Для новых записей требуем наличие файлов
        if (!this.arContent || !this.arContent.id) {
            const hasBasicFields = this.selectedCompany &&
                   this.selectedProject &&
                   document.getElementById('customer_name')?.value &&
                   document.getElementById('duration_years')?.value;
                   
            // Проверяем наличие файлов через DOM
            const photoInput = document.querySelector('input[type="file"][name="photo_file"]');
            const videoInput = document.querySelector('input[type="file"][name="video_file"]');
            const hasFiles = (photoInput && photoInput.files.length > 0) &&
                            (videoInput && videoInput.files.length > 0);
                   
            return hasBasicFields && hasFiles;
        } else {
            // Для редактирования
            const hasBasicFields = this.selectedCompany &&
                   this.selectedProject &&
                   document.getElementById('customer_name')?.value &&
                   document.getElementById('duration_years')?.value;
            
            // При редактировании файлы могут быть уже загружены
            const photoInput = document.querySelector('input[type="file"][name="photo_file"]');
            const videoInput = document.querySelector('input[type="file"][name="video_file"]');
            const hasNewFiles = (!photoInput || photoInput.files.length === 0) &&
                               (!videoInput || videoInput.files.length === 0);
            
            // Если нет новых файлов, проверяем, были ли файлы ранее
            if (hasNewFiles && this.arContent) {
                const hasExistingFiles = this.arContent.photo_url &&
                                        this.arContent.video_url;
                return hasBasicFields && hasExistingFiles;
            }
            
            const hasFiles = (photoInput && photoInput.files.length > 0) &&
                            (videoInput && videoInput.files.length > 0);
            
            return hasBasicFields && hasFiles;
        }
    },
    
    async submitForm() {
        if (!this.isValid) {
            this.showToast('Пожалуйста, заполните все обязательные поля', 'error');
            return;
        }
        
        this.submitting = true;
        
        try {
            const formData = new FormData();
            formData.append('company_id', this.selectedCompany);
            formData.append('project_id', this.selectedProject);
            formData.append('customer_name', document.getElementById('customer_name').value);
            formData.append('customer_phone', document.getElementById('customer_phone').value);
            formData.append('customer_email', document.getElementById('customer_email').value);
            formData.append('duration_years', document.getElementById('duration_years').value);
            
            // Добавляем файлы из соответствующих input'ов
            const photoInput = document.querySelector('input[type="file"][name="photo_file"]');
            const videoInput = document.querySelector('input[type="file"][name="video_file"]');
            
            if (photoInput && photoInput.files.length > 0) {
                formData.append('photo_file', photoInput.files[0]);
            }
            if (videoInput && videoInput.files.length > 0) {
                formData.append('video_file', videoInput.files[0]);
            }
            
            let url, method;
            if (this.arContent && this.arContent.id) {
                // Update existing AR content
                url = `/companies/${this.selectedCompany}/projects/${this.selectedProject}/ar-content/${this.arContent.id}`;
                method = 'POST';
                formData.append('_method', 'PUT');
            } else {
                // Create new AR content
                url = `/companies/${this.selectedCompany}/projects/${this.selectedProject}/ar-content`;
                method = 'POST';
            }
            
            const response = await fetch(url, {
                method: method,
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                this.showToast(this.arContent && this.arContent.id ? 'AR контент успешно обновлен' : 'AR контент успешно создан', 'success');
                window.location.href = `/ar-content/${result.id || this.arContent.id}`;
            } else {
                throw new Error('Request failed');
            }
        } catch (error) {
            this.showToast('Не удалось сохранить AR контент', 'error');
            console.error('Submit error:', error);
        } finally {
            this.submitting = false;
        }
    },
    
    showToast(message, type = 'info') {
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-4 py-2 rounded shadow z-50`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 3000);
    }
}"
     x-init="setTimeout(() => {
         console.log('Cascade Select Component initialized');
         console.log('companies count:', {{ companies_js|length }});
         {% if ar_content and ar_content.company_id %}
             selectedCompany = '{{ ar_content.company_id }}';
             loadProjects();
         {% endif %}
     }, 200);">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                {% if ar_content and ar_content.id %}Редактировать AR контент{% else %}Создать AR контент{% endif %}
            </h1>
            <a href="{% if ar_content %}/ar-content/{{ ar_content.id }}{% else %}/ar-content{% endif %}" class="btn btn-secondary">
                <span class="material-icons mr-2">arrow_back</span>Назад
            </a>
        </div>

        <form @submit.prevent="submitForm" method="post" enctype="multipart/form-data" class="bg-white dark:bg-gray-800 shadow rounded-lg">
            <!-- Company & Project Selection -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Компания и проект</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="company_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Компания <span class="text-red-500">*</span>
                        </label>
                        <select name="company_id" id="company_id"
                                class="form-select"
                                x-model="selectedCompany"
                                @change="loadProjects()"
                                required x-cloak>
                            <option value="">Выберите компанию</option>
                            <template x-for="company in companies" :key="company.id">
                                <option :value="company.id" x-text="company.name"></option>
                            </template>
                        </select>
                    </div>
                    
                    <div>
                        <label for="project_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Проект <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <select name="project_id" id="project_id"
                                    class="form-select"
                                    x-model="selectedProject"
                                    :disabled="loading"
                                    required x-cloak>
                                <option value="">Выберите проект</option>
                                <template x-for="project in projects" :key="project.id">
                                    <option :value="project.id" x-text="project.name"></option>
                                </template>
                            </select>
                            <div x-show="loading" class="absolute inset-y-0 right-0 flex items-center pr-3">
                                <span class="animate-spin material-icons text-gray-400">autorenew</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Information -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Информация о заказчике</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="customer_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Имя заказчика
                        </label>
                        <input type="text" name="customer_name" id="customer_name"
                               class="form-input"
                               placeholder="Имя Фамилия" x-cloak>
                    </div>
                    
                    <div>
                        <label for="customer_phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Телефон
                        </label>
                        <input type="tel" name="customer_phone" id="customer_phone"
                               class="form-input"
                               placeholder="+7 (999) 123-45-67" x-cloak>
                    </div>
                    
                    <div>
                        <label for="customer_email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Email
                        </label>
                        <input type="email" name="customer_email" id="customer_email"
                               class="form-input"
                               placeholder="customer@example.com" x-cloak>
                    </div>
                </div>
            </div>

            <!-- Duration -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Длительность доступа</h3>
                <div>
                    <label for="duration_years" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Период действия <span class="text-red-500">*</span>
                    </label>
                    <select name="duration_years" id="duration_years"
                            class="form-select"
                            required x-cloak>
                        <option value="1">1 год</option>
                        <option value="3">3 года</option>
                        <option value="5">5 лет</option>
                    </select>
                </div>
            </div>

            <!-- File Upload -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Файлы контента</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Photo Upload -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Портрет (изображение) <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <div class="photo-upload-area"
                                 x-data="photoUploader()"
                                 x-init="init()"
                                 @click="triggerFileInput()"
                                 @dragover.prevent="dragOver = true"
                                 @dragleave.prevent="dragOver = false"
                                 @drop.prevent="handleDrop($event)"
                                 :class="dragOver ? 'border-blue-400 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-300 dark:border-gray-600'"
                                 class="relative cursor-pointer rounded-lg border-2 border-dashed p-6 text-center hover:border-gray-400 dark:hover:border-gray-500 transition-all duration-200">
                                
                                <!-- Hidden file input -->
                                <input type="file" 
                                       x-ref="fileInput" 
                                       accept="image/*" 
                                       @change="handleFileSelect($event)"
                                       class="hidden">
                                
                                <!-- Upload icon and text -->
                                <div x-show="!selectedFile" class="space-y-2">
                                    <div class="text-gray-400">
                                        <span class="material-icons text-4xl">cloud_upload</span>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        <span class="font-medium text-indigo-600 dark:text-indigo-400">Нажмите для выбора</span> или перетащите файл сюда
                                    </p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">
                                        PNG, JPG до 10MB
                                    </p>
                                </div>
                                
                                <!-- Preview area -->
                                <div x-show="selectedFile" class="space-y-3">
                                    <div class="relative inline-block">
                                        <img :src="previewUrl" 
                                             alt="Preview" 
                                             class="mx-auto h-32 w-32 object-cover rounded-lg border border-gray-300 dark:border-gray-600">
                                        <button type="button"
                                                @click.stop="removeFile()"
                                                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors">
                                            <span class="material-icons text-sm">close</span>
                                        </button>
                                    </div>
                                    <div class="text-sm">
                                        <p class="font-medium text-gray-900 dark:text-white" x-text="selectedFile.name"></p>
                                        <p class="text-gray-500 dark:text-gray-400" x-text="formatFileSize(selectedFile.size)"></p>
                                    </div>
                                </div>
                                
                                <!-- Loading overlay -->
                                <div x-show="uploading" 
                                     x-transition:enter="transition-opacity duration-300"
                                     x-transition:enter-start="opacity-0"
                                     x-transition:enter-end="opacity-100"
                                     x-transition:leave="transition-opacity duration-300"
                                     x-transition:leave-start="opacity-100"
                                     x-transition:leave-end="opacity-0"
                                     class="absolute inset-0 bg-white/80 dark:bg-gray-900/80 rounded-lg flex items-center justify-center">
                                    <div class="text-center">
                                        <span class="material-icons text-3xl text-blue-500 animate-spin">refresh</span>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Загрузка...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Video Upload -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Видео <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <div class="video-upload-area"
                                 x-data="videoUploader()"
                                 x-init="init()"
                                 @click="triggerFileInput()"
                                 @dragover.prevent="dragOver = true"
                                 @dragleave.prevent="dragOver = false"
                                 @drop.prevent="handleDrop($event)"
                                 :class="dragOver ? 'border-blue-400 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-300 dark:border-gray-600'"
                                 class="relative cursor-pointer rounded-lg border-2 border-dashed p-6 text-center hover:border-gray-400 dark:hover:border-gray-500 transition-all duration-200">
                                
                                <!-- Hidden file input -->
                                <input type="file" 
                                       x-ref="fileInput" 
                                       accept="video/*" 
                                       @change="handleFileSelect($event)"
                                       class="hidden">
                                
                                <!-- Upload icon and text -->
                                <div x-show="!selectedFile" class="space-y-2">
                                    <div class="text-gray-400">
                                        <span class="material-icons text-4xl">videocam</span>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        <span class="font-medium text-indigo-600 dark:text-indigo-400">Нажмите для выбора</span> или перетащите файл сюда
                                    </p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">
                                        MP4, WebM, MOV до 100MB
                                    </p>
                                </div>
                                
                                <!-- Preview area -->
                                <div x-show="selectedFile" class="space-y-3">
                                    <div class="relative inline-block">
                                        <video :src="previewUrl" 
                                               class="mx-auto h-32 w-32 object-cover rounded-lg border border-gray-300 dark:border-gray-600"
                                               controls></video>
                                        <button type="button"
                                                @click.stop="removeFile()"
                                                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors">
                                            <span class="material-icons text-sm">close</span>
                                        </button>
                                    </div>
                                    <div class="text-sm">
                                        <p class="font-medium text-gray-900 dark:text-white" x-text="selectedFile.name"></p>
                                        <p class="text-gray-500 dark:text-gray-400" x-text="formatFileSize(selectedFile.size)"></p>
                                    </div>
                                </div>
                                
                                <!-- Loading overlay -->
                                <div x-show="uploading" 
                                     x-transition:enter="transition-opacity duration-300"
                                     x-transition:enter-start="opacity-0"
                                     x-transition:enter-end="opacity-100"
                                     x-transition:leave="transition-opacity duration-300"
                                     x-transition:leave-start="opacity-100"
                                     x-transition:leave-end="opacity-0"
                                     class="absolute inset-0 bg-white/80 dark:bg-gray-900/80 rounded-lg flex items-center justify-center">
                                    <div class="text-center">
                                        <span class="material-icons text-3xl text-blue-500 animate-spin">refresh</span>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Загрузка...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status (only for edit) -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700" x-show="arContent && arContent.id">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Статус</h3>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Статус заказа
                    </label>
                    <select name="status" id="status"
                            class="form-select"
                            x-cloak>
                        <option value="pending">В ожидании</option>
                        <option value="processing">В обработке</option>
                        <option value="ready">Готов</option>
                        <option value="failed">Ошибка</option>
                    </select>
                </div>
            </div>

            <!-- Actions -->
            <div class="p-6 bg-gray-50 dark:bg-gray-700 rounded-b-lg">
                <!-- Debug info for troubleshooting -->
                <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-md text-sm">
                    <p class="font-medium text-blue-800 dark:text-blue-200">Debug Info:</p>
                    <ul class="text-blue-700 dark:text-blue-300 mt-1">
                        <li>arContent: <span x-text="JSON.stringify(arContent)"></span></li>
                        <li>isValid exists: <span x-text="typeof isValid !== 'undefined'"></span></li>
                        <li>isValid value: <span x-text="typeof isValid !== 'undefined' ? isValid : 'undefined'"></span></li>
                        <li>submitting: <span x-text="typeof submitting !== 'undefined' ? submitting : 'undefined'"></span></li>
                    </ul>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <a href="{% if ar_content %}/ar-content/{{ ar_content.id }}{% else %}/ar-content{% endif %}" 
                       class="btn btn-secondary inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 dark:bg-gray-600 dark:hover:bg-gray-700">
                        <span class="material-icons mr-2">close</span>
                        Отмена
                    </a>
                    <button type="submit"
                            x-bind:disabled="!isValid || submitting"
                            x-bind:class="{'opacity-50 cursor-not-allowed': !isValid || submitting}"
                            class="btn btn-primary inline-flex items-center px-6 py-3 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="material-icons mr-2" x-show="!submitting">save</span>
                        <span class="material-icons mr-2 animate-spin" x-show="submitting">refresh</span>
                        <span x-show="!submitting">
                            {% if ar_content and ar_content.id %}Обновить AR контент{% else %}Создать AR контент{% endif %}
                        </span>
                        <span x-show="submitting">Сохранение...</span>
                    </button>
                </div>
                
                <!-- Debug information -->
                <div x-show="!isValid" class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-md">
                    <p class="text-sm text-yellow-800 dark:text-yellow-200 mb-2">
                        <span class="material-icons text-sm mr-1">info</span>
                        Пожалуйста, заполните все обязательные поля:
                    </p>
                    <ul class="text-xs text-yellow-700 dark:text-yellow-300 list-disc list-inside">
                        <li x-show="!selectedCompany">Компания</li>
                        <li x-show="!selectedProject">Проект</li>
                        <li x-show="!document.getElementById('customer_name')?.value">Имя заказчика</li>
                        <li x-show="!document.getElementById('duration_years')?.value">Период действия</li>
                        <li x-show="!arContent || !arContent.id">
                            <span x-show="!document.querySelector('input[type=file][name=photo_file]')?.files.length > 0">Портрет (изображение)</span>
                            <span x-show="!document.querySelector('input[type=file][name=video_file]')?.files.length > 0">Видео</span>
                        </li>
                    </ul>
                </div>
                
                <!-- Development helper - remove in production -->
                <div x-show="!isValid && (arContent && arContent.id)" class="mt-2 p-2 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-md">
                    <p class="text-xs text-blue-700 dark:text-blue-300">
                        <span class="material-icons text-xs mr-1">bug_report</span>
                        Для тестирования: проверьте правильность заполнения полей
                    </p>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// Photo uploader component
function photoUploader() {
    return {
        selectedFile: null,
        previewUrl: null,
        uploading: false,
        dragOver: false,
        
        init() {
            // Initialize with existing photo if editing
            if (this.$root.arContent && this.$root.arContent.photo_url) {
                this.previewUrl = this.$root.arContent.photo_url;
            }
        },
        
        triggerFileInput() {
            this.$refs.fileInput.click();
        },
        
        handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                this.processFile(file);
            }
        },
        
        handleDrop(event) {
            this.dragOver = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                this.processFile(files[0]);
            }
        },
        
        processFile(file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                this.showToast('Пожалуйста, выберите изображение', 'error');
                return;
            }
            
            // Validate file size (10MB)
            if (file.size > 10 * 1024 * 1024) {
                this.showToast('Размер файла не должен превышать 10MB', 'error');
                return;
            }
            
            this.selectedFile = file;
            this.previewUrl = URL.createObjectURL(file);
        },
        
        removeFile() {
            this.selectedFile = null;
            if (this.previewUrl && this.previewUrl.startsWith('blob:')) {
                URL.revokeObjectURL(this.previewUrl);
            }
            this.previewUrl = null;
            this.$refs.fileInput.value = '';
        },
        
        formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },
        
        showToast(message, type = 'info') {
            if (this.$root.showToast) {
                this.$root.showToast(message, type);
            }
        }
    }
}

// Video uploader component
function videoUploader() {
    return {
        selectedFile: null,
        previewUrl: null,
        uploading: false,
        dragOver: false,
        
        init() {
            // Initialize with existing video if editing
            if (this.$root.arContent && this.$root.arContent.video_url) {
                this.previewUrl = this.$root.arContent.video_url;
            }
        },
        
        triggerFileInput() {
            this.$refs.fileInput.click();
        },
        
        handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                this.processFile(file);
            }
        },
        
        handleDrop(event) {
            this.dragOver = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                this.processFile(files[0]);
            }
        },
        
        processFile(file) {
            // Validate file type
            if (!file.type.startsWith('video/')) {
                this.showToast('Пожалуйста, выберите видеофайл', 'error');
                return;
            }
            
            // Validate file size (100MB)
            if (file.size > 100 * 1024 * 1024) {
                this.showToast('Размер файла не должен превышать 100MB', 'error');
                return;
            }
            
            this.selectedFile = file;
            this.previewUrl = URL.createObjectURL(file);
        },
        
        removeFile() {
            this.selectedFile = null;
            if (this.previewUrl && this.previewUrl.startsWith('blob:')) {
                URL.revokeObjectURL(this.previewUrl);
            }
            this.previewUrl = null;
            this.$refs.fileInput.value = '';
        },
        
        formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },
        
        showToast(message, type = 'info') {
            if (this.$root.showToast) {
                this.$root.showToast(message, type);
            }
        }
    }
}
</script>
{% endblock %}