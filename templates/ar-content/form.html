{% extends "base.html" %}

{% block title %}{% if ar_content and ar_content.id %}Edit AR Content - Vertex AR Admin{% else %}Create AR Content - Vertex AR Admin{% endif %}{% endblock %}
{% block page_title %}{% if ar_content and ar_content.id %}Edit AR Content{% else %}Create AR Content{% endif %}{% endblock %}

{% block content %}
<script type="application/json" id="companies-data">{{ companies_js | tojson }}</script>
<script type="application/json" id="projects-data">{{ projects_js | tojson }}</script>
<script type="application/json" id="ar-content-data">{{ ar_content | tojson if ar_content else 'null' }}</script>

<div x-data="arContentForm()" x-init="init()" @photo-selected.window="hasNewPhoto = $event.detail" @video-selected.window="hasNewVideo = $event.detail">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                {% if ar_content and ar_content.id %}Редактировать AR контент{% else %}Создать AR контент{% endif %}
            </h1>
            <a href="{% if ar_content %}/ar-content/{{ ar_content.id }}{% else %}/ar-content{% endif %}" class="btn btn-secondary">
                <span class="material-icons mr-2">arrow_back</span>Назад
            </a>
        </div>

        <form @submit.prevent="submitForm" method="post" enctype="multipart/form-data" class="bg-white dark:bg-gray-800 shadow rounded-lg">
            <!-- Company & Project Selection -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Компания и проект</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="company_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Компания <span class="text-red-500">*</span>
                        </label>
                        <select name="company_id" id="company_id"
                                class="form-select"
                                x-model="selectedCompany"
                                :disabled="arContent && arContent.id"
                                @change="loadProjects()"
                                required x-cloak>
                            <option value="">Выберите компанию</option>
                            <template x-for="company in companies" :key="company.id">
                                <option :value="company.id" x-text="company.name"></option>
                            </template>
                        </select>
                    </div>
                    
                    <div>
                        <label for="project_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Проект <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <select name="project_id" id="project_id"
                                    class="form-select"
                                    x-model="selectedProject"
                                    :disabled="loading || !selectedCompany || (arContent && arContent.id)"
                                    required x-cloak>
                                <option value="">Выберите проект</option>
                                <template x-for="project in projects" :key="project.id">
                                    <option :value="project.id" x-text="project.name"></option>
                                </template>
                            </select>
                            <div x-show="loading" class="absolute inset-y-0 right-0 flex items-center pr-3">
                                <span class="animate-spin material-icons text-gray-400">autorenew</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Information -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Информация о заказчике</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="customer_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Имя заказчика <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="customer_name" id="customer_name"
                               class="form-input"
                               x-model="customerName"
                               placeholder="Имя Фамилия"
                               value="{{ ar_content.customer_name if ar_content and ar_content.customer_name else '' }}"
                               required x-cloak>
                    </div>
                    
                    <div>
                        <label for="customer_phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Телефон
                        </label>
                        <input type="tel" name="customer_phone" id="customer_phone"
                               class="form-input"
                               x-model="customerPhone"
                               placeholder="+7 (999) 123-45-67"
                               value="{{ ar_content.customer_phone if ar_content and ar_content.customer_phone else '' }}" x-cloak>
                    </div>
                    
                    <div>
                        <label for="customer_email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Email
                        </label>
                        <input type="email" name="customer_email" id="customer_email"
                               class="form-input"
                               x-model="customerEmail"
                               placeholder="customer@example.com"
                               value="{{ ar_content.customer_email if ar_content and ar_content.customer_email else '' }}" x-cloak>
                    </div>
                </div>
            </div>

            <!-- Duration (hidden, default 30 years) -->
            <input type="hidden" name="duration_years" :value="durationYears">

            <!-- File Upload -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Файлы контента</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Photo Upload -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Портрет (изображение) <span class="text-red-500">*</span>
                        </label>
                        <div class="relative" x-data="photoUploader()" x-init="init()">
                            <div class="photo-upload-area"
                                 @click="triggerFileInput()"
                                 @dragover.prevent="dragOver = true"
                                 @dragleave.prevent="dragOver = false"
                                 @drop.prevent="handleDrop($event)"
                                 :class="dragOver ? 'border-blue-400 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-300 dark:border-gray-600'"
                                 class="relative cursor-pointer rounded-lg border-2 border-dashed p-6 text-center hover:border-gray-400 dark:hover:border-gray-500 transition-all duration-200">
                                
                                <!-- Hidden file input -->
                                <input type="file"
                                       id="photo_file"
                                       name="photo_file"
                                       x-ref="fileInput"
                                       accept="image/*"
                                       @change="handleFileSelect($event)"
                                       class="hidden">
                                
                                <!-- Upload icon and text -->
                                <div x-show="!previewUrl" class="space-y-2">
                                    <div class="text-gray-400">
                                        <span class="material-icons text-4xl">cloud_upload</span>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        <span class="font-medium text-indigo-600 dark:text-indigo-400">Нажмите для выбора</span> или перетащите файл сюда
                                    </p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">
                                        PNG, JPG до 10MB
                                    </p>
                                </div>

                                <!-- Preview area (new or existing) -->
                                <div x-show="previewUrl" class="space-y-3">
                                    <div class="relative inline-block">
                                        <img :src="previewUrl"
                                             alt="Preview"
                                             class="mx-auto h-32 w-32 object-cover rounded-lg border border-gray-300 dark:border-gray-600">
                                        <button type="button"
                                                x-show="selectedFile"
                                                @click.stop="removeFile()"
                                                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors">
                                            <span class="material-icons text-sm">close</span>
                                        </button>
                                    </div>
                                    <div class="text-sm">
                                        <p class="font-medium text-gray-900 dark:text-white" x-text="selectedFile ? selectedFile.name : 'Текущий файл'"></p>
                                        <p class="text-gray-500 dark:text-gray-400" x-show="selectedFile" x-text="selectedFile ? formatFileSize(selectedFile.size) : ''"></p>
                                    </div>
                                </div>
                                
                                <!-- Loading overlay -->
                                <div x-show="uploading" 
                                     x-transition:enter="transition-opacity duration-300"
                                     x-transition:enter-start="opacity-0"
                                     x-transition:enter-end="opacity-100"
                                     x-transition:leave="transition-opacity duration-300"
                                     x-transition:leave-start="opacity-100"
                                     x-transition:leave-end="opacity-0"
                                     class="absolute inset-0 bg-white/80 dark:bg-gray-900/80 rounded-lg flex items-center justify-center">
                                    <div class="text-center">
                                        <span class="material-icons text-3xl text-blue-500 animate-spin">refresh</span>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Загрузка...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Quality analysis: spinner -->
                            <div x-show="analyzing" x-transition class="mt-3 flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                                <span class="material-icons text-base animate-spin">refresh</span>
                                <span>Анализ качества маркера...</span>
                            </div>

                            <!-- Quality analysis: result card -->
                            <div x-show="qualityResult && !analyzing"
                                 x-transition:enter="transition-all duration-300"
                                 x-transition:enter-start="opacity-0 -translate-y-1"
                                 x-transition:enter-end="opacity-100 translate-y-0"
                                 class="mt-3 rounded-lg border p-3 text-sm"
                                 :class="{
                                     'border-green-300 bg-green-50 dark:border-green-700 dark:bg-green-900/20': qualityColor() === 'green',
                                     'border-yellow-300 bg-yellow-50 dark:border-yellow-700 dark:bg-yellow-900/20': qualityColor() === 'yellow',
                                     'border-red-300 bg-red-50 dark:border-red-700 dark:bg-red-900/20': qualityColor() === 'red',
                                 }">

                                <!-- Header: icon + label -->
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="material-icons text-lg"
                                          :class="{
                                              'text-green-600 dark:text-green-400': qualityColor() === 'green',
                                              'text-yellow-600 dark:text-yellow-400': qualityColor() === 'yellow',
                                              'text-red-600 dark:text-red-400': qualityColor() === 'red',
                                          }"
                                          x-text="qualityColor() === 'green' ? 'check_circle' : qualityColor() === 'yellow' ? 'warning' : 'error'">
                                    </span>
                                    <span class="font-medium"
                                          :class="{
                                              'text-green-800 dark:text-green-300': qualityColor() === 'green',
                                              'text-yellow-800 dark:text-yellow-300': qualityColor() === 'yellow',
                                              'text-red-800 dark:text-red-300': qualityColor() === 'red',
                                          }"
                                          x-text="qualityLabel()">
                                    </span>
                                </div>

                                <!-- Progress bar -->
                                <div class="mb-2">
                                    <div class="flex items-center justify-between text-xs mb-1">
                                        <span class="text-gray-600 dark:text-gray-400">Вероятность распознавания</span>
                                        <span class="font-semibold"
                                              :class="{
                                                  'text-green-700 dark:text-green-300': qualityColor() === 'green',
                                                  'text-yellow-700 dark:text-yellow-300': qualityColor() === 'yellow',
                                                  'text-red-700 dark:text-red-300': qualityColor() === 'red',
                                              }"
                                              x-text="qualityPercent() + '%'">
                                        </span>
                                    </div>
                                    <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                        <div class="h-full rounded-full transition-all duration-500"
                                             :class="{
                                                 'bg-green-500': qualityColor() === 'green',
                                                 'bg-yellow-500': qualityColor() === 'yellow',
                                                 'bg-red-500': qualityColor() === 'red',
                                             }"
                                             :style="'width:' + qualityPercent() + '%'">
                                        </div>
                                    </div>
                                </div>

                                <!-- Mini metrics grid -->
                                <div class="grid grid-cols-3 gap-2 mb-2" x-show="qualityResult && qualityResult.metrics">
                                    <div class="bg-white/60 dark:bg-gray-800/40 rounded px-2 py-1 text-center">
                                        <div class="text-[10px] text-gray-500 dark:text-gray-400 uppercase tracking-wide">Контраст</div>
                                        <div class="text-xs font-semibold text-gray-800 dark:text-gray-200" x-text="qualityResult && qualityResult.metrics ? qualityResult.metrics.contrast.toFixed(1) : ''"></div>
                                    </div>
                                    <div class="bg-white/60 dark:bg-gray-800/40 rounded px-2 py-1 text-center">
                                        <div class="text-[10px] text-gray-500 dark:text-gray-400 uppercase tracking-wide">Резкость</div>
                                        <div class="text-xs font-semibold text-gray-800 dark:text-gray-200" x-text="qualityResult && qualityResult.metrics ? qualityResult.metrics.sharpness.toFixed(1) : ''"></div>
                                    </div>
                                    <div class="bg-white/60 dark:bg-gray-800/40 rounded px-2 py-1 text-center">
                                        <div class="text-[10px] text-gray-500 dark:text-gray-400 uppercase tracking-wide">Яркость</div>
                                        <div class="text-xs font-semibold text-gray-800 dark:text-gray-200" x-text="qualityResult && qualityResult.metrics ? qualityResult.metrics.brightness.toFixed(1) : ''"></div>
                                    </div>
                                </div>

                                <!-- Resolution -->
                                <div class="text-xs text-gray-500 dark:text-gray-400 mb-2" x-show="qualityResult && qualityResult.resolution">
                                    <span x-text="qualityResult && qualityResult.resolution ? qualityResult.resolution.width + ' x ' + qualityResult.resolution.height + ' px' : ''"></span>
                                </div>

                                <!-- Recommendations -->
                                <template x-if="qualityResult && qualityResult.recommendations && qualityResult.quality_level !== 'good'">
                                    <div class="space-y-1 border-t pt-2 mt-1"
                                         :class="{
                                             'border-yellow-200 dark:border-yellow-800': qualityColor() === 'yellow',
                                             'border-red-200 dark:border-red-800': qualityColor() === 'red',
                                         }">
                                        <template x-for="rec in qualityResult.recommendations" :key="rec">
                                            <div class="flex items-start gap-1.5 text-xs"
                                                 :class="{
                                                     'text-yellow-700 dark:text-yellow-300': qualityColor() === 'yellow',
                                                     'text-red-700 dark:text-red-300': qualityColor() === 'red',
                                                 }">
                                                <span class="material-icons text-xs mt-0.5 shrink-0">info</span>
                                                <span x-text="rec"></span>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Video Upload -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Видео <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <div class="video-upload-area"
                                 x-data="videoUploader()"
                                 x-init="init()"
                                 @click="triggerFileInput()"
                                 @dragover.prevent="dragOver = true"
                                 @dragleave.prevent="dragOver = false"
                                 @drop.prevent="handleDrop($event)"
                                 :class="dragOver ? 'border-blue-400 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-300 dark:border-gray-600'"
                                 class="relative cursor-pointer rounded-lg border-2 border-dashed p-6 text-center hover:border-gray-400 dark:hover:border-gray-500 transition-all duration-200">
                                
                                <!-- Hidden file input -->
                                <input type="file"
                                       id="video_file"
                                       name="video_file"
                                       x-ref="fileInput"
                                       accept="video/*"
                                       @change="handleFileSelect($event)"
                                       class="hidden">
                                
                                <!-- Upload icon and text -->
                                <div x-show="!previewUrl" class="space-y-2">
                                    <div class="text-gray-400">
                                        <span class="material-icons text-4xl">videocam</span>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        <span class="font-medium text-indigo-600 dark:text-indigo-400">Нажмите для выбора</span> или перетащите файл сюда
                                    </p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">
                                        MP4, WebM, MOV до 100MB
                                    </p>
                                </div>

                                <!-- Preview area (new or existing) -->
                                <div x-show="previewUrl" class="space-y-3">
                                    <div class="relative inline-block">
                                        <video :src="previewUrl"
                                               class="mx-auto h-32 w-32 object-cover rounded-lg border border-gray-300 dark:border-gray-600"
                                               controls></video>
                                        <button type="button"
                                                x-show="selectedFile"
                                                @click.stop="removeFile()"
                                                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors">
                                            <span class="material-icons text-sm">close</span>
                                        </button>
                                    </div>
                                    <div class="text-sm">
                                        <p class="font-medium text-gray-900 dark:text-white" x-text="selectedFile ? selectedFile.name : 'Текущий файл'"></p>
                                        <p class="text-gray-500 dark:text-gray-400" x-show="selectedFile" x-text="selectedFile ? formatFileSize(selectedFile.size) : ''"></p>
                                    </div>
                                </div>
                                
                                <!-- Loading overlay -->
                                <div x-show="uploading" 
                                     x-transition:enter="transition-opacity duration-300"
                                     x-transition:enter-start="opacity-0"
                                     x-transition:enter-end="opacity-100"
                                     x-transition:leave="transition-opacity duration-300"
                                     x-transition:leave-start="opacity-100"
                                     x-transition:leave-end="opacity-0"
                                     class="absolute inset-0 bg-white/80 dark:bg-gray-900/80 rounded-lg flex items-center justify-center">
                                    <div class="text-center">
                                        <span class="material-icons text-3xl text-blue-500 animate-spin">refresh</span>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Загрузка...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status (only for edit) -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700" x-show="arContent && arContent.id">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Статус</h3>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Статус заказа
                    </label>
                    <select name="status" id="status"
                            class="form-select"
                            x-cloak>
                        <option value="pending" {% if ar_content and ar_content.status == 'pending' %}selected{% endif %}>В ожидании</option>
                        <option value="processing" {% if ar_content and ar_content.status == 'processing' %}selected{% endif %}>В обработке</option>
                        <option value="ready" {% if ar_content and ar_content.status == 'ready' %}selected{% endif %}>Готов</option>
                        <option value="failed" {% if ar_content and ar_content.status == 'failed' %}selected{% endif %}>Ошибка</option>
                    </select>
                </div>
            </div>

            <!-- Actions -->
            <div class="p-6 bg-gray-50 dark:bg-gray-700 rounded-b-lg">
                <div class="flex justify-end space-x-3">
                    <a href="{% if ar_content %}/ar-content/{{ ar_content.id }}{% else %}/ar-content{% endif %}" 
                       class="btn btn-secondary inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 dark:bg-gray-600 dark:hover:bg-gray-700">
                        <span class="material-icons mr-2">close</span>
                        Отмена
                    </a>
                    <button type="submit"
                            x-bind:disabled="!isValid || submitting"
                            x-bind:class="{'opacity-50 cursor-not-allowed': !isValid || submitting}"
                            class="btn btn-primary inline-flex items-center px-6 py-3 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="material-icons mr-2" x-show="!submitting">save</span>
                        <span class="material-icons mr-2 animate-spin" x-show="submitting">refresh</span>
                        <span x-show="!submitting">
                            {% if ar_content and ar_content.id %}Обновить AR контент{% else %}Создать AR контент{% endif %}
                        </span>
                        <span x-show="submitting">Сохранение...</span>
                    </button>
                </div>
                
                <!-- Debug information -->
                <div x-show="!isValid" class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-md">
                    <p class="text-sm text-yellow-800 dark:text-yellow-200 mb-2">
                        <span class="material-icons text-sm mr-1">info</span>
                        Пожалуйста, заполните все обязательные поля:
                    </p>
                    <ul class="text-xs text-yellow-700 dark:text-yellow-300 list-disc list-inside">
                        <li x-show="!selectedCompany">Компания</li>
                        <li x-show="!selectedProject">Проект</li>
                        <li x-show="!customerName">Имя заказчика</li>
                        <!-- duration_years скрыт, всегда 30 -->
                        <li x-show="(!arContent || !arContent.id) && !hasNewPhoto">Портрет (изображение)</li>
                        <li x-show="(!arContent || !arContent.id) && !hasNewVideo">Видео</li>
                    </ul>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
function arContentForm() {
    const companies = JSON.parse(document.getElementById('companies-data')?.textContent || '[]');
    const allProjects = JSON.parse(document.getElementById('projects-data')?.textContent || '[]');
    const arContent = JSON.parse(document.getElementById('ar-content-data')?.textContent || 'null');
    const selectedCompany = arContent?.company_id ? String(arContent.company_id) : '';
    const selectedProject = arContent?.project_id ? String(arContent.project_id) : '';

    return {
        companies,
        allProjects,
        projects: [],
        selectedCompany,
        selectedProject,
        arContent,
        customerName: arContent?.customer_name ? String(arContent.customer_name) : '',
        customerPhone: arContent?.customer_phone ? String(arContent.customer_phone) : '',
        customerEmail: arContent?.customer_email ? String(arContent.customer_email) : '',
        durationYears: arContent?.duration_years ? String(arContent.duration_years) : '30',
        hasNewPhoto: false,
        hasNewVideo: false,
        loading: false,
        submitting: false,

        init() {
            // Initial projects load if company is pre-selected (e.g. in edit mode)
            if (this.selectedCompany) {
                this.loadProjects();
            }

            // Watch for company changes to reload projects
            this.$watch('selectedCompany', () => {
                this.loadProjects();
            });
        },

        async loadProjects() {
            if (!this.selectedCompany) {
                this.projects = [];
                this.selectedProject = '';
                return;
            }

            this.loading = true;

            // Step 1: Try to filter from allProjects first (optimistic load)
            const localProjects = this.allProjects.filter(
                (project) => String(project.company_id) === String(this.selectedCompany)
            );
            if (localProjects.length > 0) {
                this.projects = localProjects;
                // We still continue to fetch from API to get the most fresh/complete list
            }

            try {
                const response = await fetch(`/api/projects/by-company/${this.selectedCompany}`, {
                    credentials: 'same-origin',
                });
                if (!response.ok) {
                    // If local projects exist, we don't throw to avoid UI disruption
                    if (this.projects.length === 0) {
                        let errorPayload = null;
                        try {
                            errorPayload = await response.json();
                        } catch (e) {}
                        throw new Error(
                            errorPayload?.detail || response.statusText || 'Не удалось загрузить проекты'
                        );
                    }
                    return;
                }

                const data = await response.json();
                const apiProjects = data.projects || [];

                // Merge or replace projects
                if (apiProjects.length > 0) {
                    this.projects = apiProjects;
                } else if (localProjects.length > 0) {
                    // Keep local ones if API returned empty but we have some locals
                    this.projects = localProjects;
                } else {
                    this.projects = [];
                }

                // Validate selected project
                if (this.selectedProject && !this.projects.some((p) => String(p.id) === String(this.selectedProject))) {
                    this.selectedProject = '';
                }
            } catch (error) {
                console.error('Ошибка при загрузке проектов:', error);
                if (this.projects.length === 0) {
                    this.projects = [];
                    this.selectedProject = '';
                    this.showToast(error?.message || 'Не удалось загрузить проекты', 'error');
                }
            } finally {
                this.loading = false;
            }
        },

        get isValid() {
            const hasBasicFields =
                this.selectedCompany &&
                this.selectedProject &&
                this.customerName &&
                this.durationYears;

            if (!this.arContent || !this.arContent.id) {
                return hasBasicFields && this.hasNewPhoto && this.hasNewVideo;
            }

            const hasExistingPhoto = !!this.arContent.photo_url;
            const hasExistingVideo = !!this.arContent.video_url;
            return (
                hasBasicFields &&
                (this.hasNewPhoto || hasExistingPhoto) &&
                (this.hasNewVideo || hasExistingVideo)
            );
        },

        async _readError(response) {
            try {
                const data = await response.json();
                if (typeof data?.detail === 'string') return data.detail;
                if (Array.isArray(data?.detail)) return 'Ошибка валидации';
                return 'Ошибка запроса';
            } catch (e) {
                return response.statusText || 'Ошибка запроса';
            }
        },

        async _patchFile(url, fieldName, file) {
            const fd = new FormData();
            fd.append(fieldName, file);
            const response = await fetch(url, {
                method: 'PATCH',
                body: fd,
            });
            if (!response.ok) {
                throw new Error(await this._readError(response));
            }
            return await response.json().catch(() => null);
        },

        async submitForm() {
            if (!this.isValid) {
                this.showToast('Пожалуйста, заполните все обязательные поля', 'error');
                return;
            }

            this.submitting = true;
            try {
            const customerName = this.customerName?.trim() || '';
            const customerPhone = this.customerPhone?.trim() || '';
            const customerEmail = this.customerEmail?.trim() || '';
            const durationYears = this.durationYears;

                const photoInput = document.querySelector('input[type="file"][name="photo_file"]');
                const videoInput = document.querySelector('input[type="file"][name="video_file"]');
                const photoFile = photoInput?.files?.[0] || null;
                const videoFile = videoInput?.files?.[0] || null;

                if (this.arContent && this.arContent.id) {
                    const updateUrl = `/api/companies/${this.selectedCompany}/projects/${this.selectedProject}/ar-content/${this.arContent.id}`;
                    const payload = {
                        customer_name: customerName,
                        customer_phone: customerPhone || null,
                        customer_email: customerEmail || null,
                        duration_years: Number(durationYears),
                        status: document.getElementById('status')?.value,
                    };

                    const updateResponse = await fetch(updateUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                    });

                    if (!updateResponse.ok) {
                        throw new Error(await this._readError(updateResponse));
                    }

                    await updateResponse.json().catch(() => null);

                    if (photoFile) {
                        await this._patchFile(`${updateUrl}/photo`, 'photo', photoFile);
                    }
                    if (videoFile) {
                        await this._patchFile(`${updateUrl}/video`, 'video', videoFile);
                    }

                    this.showToast('AR контент успешно обновлен', 'success');
                    window.location.href = `/ar-content/${this.arContent.id}`;
                    return;
                }

                const createUrl = `/api/companies/${this.selectedCompany}/projects/${this.selectedProject}/ar-content`;
                const formData = new FormData();
            formData.append('customer_name', customerName);
            formData.append('customer_phone', customerPhone);
                if (customerEmail) {
                    formData.append('customer_email', customerEmail);
                }
            formData.append('duration_years', durationYears);
                if (photoFile) {
                    formData.append('photo_file', photoFile);
                }
                if (videoFile) {
                    formData.append('video_file', videoFile);
                }

                const createResponse = await fetch(createUrl, {
                    method: 'POST',
                    body: formData,
                });

                if (!createResponse.ok) {
                    throw new Error(await this._readError(createResponse));
                }

                const result = await createResponse.json();
                this.showToast('AR контент успешно создан', 'success');
                window.location.href = `/ar-content/${result.id}`;
            } catch (error) {
                console.error('Submit error:', error);
                this.showToast(error?.message || 'Не удалось сохранить AR контент', 'error');
            } finally {
                this.submitting = false;
            }
        },

        showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-4 py-2 rounded shadow z-50`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 3000);
        },
    };
}

// Photo uploader component
function photoUploader() {
    return {
        selectedFile: null,
        previewUrl: null,
        uploading: false,
        dragOver: false,

        // Quality analysis state
        analyzing: false,
        qualityResult: null,

        init() {
            if (this.$root.arContent && this.$root.arContent.photo_url) {
                this.previewUrl = this.$root.arContent.photo_url;
            }
        },

        triggerFileInput() {
            this.$refs.fileInput.click();
        },

        handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                this.processFile(file);
            }
        },

        handleDrop(event) {
            this.dragOver = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                this.processFile(files[0]);
            }
        },

        processFile(file) {
            if (!file.type.startsWith('image/')) {
                this.$dispatch('photo-selected', false);
                this.showToast('Пожалуйста, выберите изображение', 'error');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                this.$dispatch('photo-selected', false);
                this.showToast('Размер файла не должен превышать 10MB', 'error');
                return;
            }

            this.selectedFile = file;
            this.previewUrl = URL.createObjectURL(file);
            this.$dispatch('photo-selected', true);
            this.analyzeQuality(file);
        },

        async analyzeQuality(file) {
            this.analyzing = true;
            this.qualityResult = null;
            try {
                const formData = new FormData();
                formData.append('photo_file', file);
                const resp = await fetch('/api/ar-content/photo/analyze', {
                    method: 'POST',
                    body: formData,
                });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    console.warn('Quality analysis failed:', err);
                    return;
                }
                this.qualityResult = await resp.json();
            } catch (e) {
                console.warn('Quality analysis error:', e);
            } finally {
                this.analyzing = false;
            }
        },

        removeFile() {
            const existingUrl = (this.$root.arContent && this.$root.arContent.photo_url)
                ? this.$root.arContent.photo_url
                : null;

            this.selectedFile = null;
            this.qualityResult = null;
            this.analyzing = false;
            if (this.previewUrl && this.previewUrl.startsWith('blob:')) {
                URL.revokeObjectURL(this.previewUrl);
            }
            this.previewUrl = existingUrl;
            this.$refs.fileInput.value = '';
            this.$dispatch('photo-selected', false);
        },

        qualityLabel() {
            if (!this.qualityResult) return '';
            const lvl = this.qualityResult.quality_level;
            if (lvl === 'good') return 'Отличное качество для AR-трекинга';
            if (lvl === 'fair') return 'Среднее качество — трекинг может быть нестабильным';
            return 'Низкое качество — высокий риск ошибки распознавания';
        },
        qualityColor() {
            if (!this.qualityResult) return 'gray';
            const lvl = this.qualityResult.quality_level;
            if (lvl === 'good') return 'green';
            if (lvl === 'fair') return 'yellow';
            return 'red';
        },
        qualityPercent() {
            if (!this.qualityResult || this.qualityResult.recognition_probability == null) return 0;
            return Math.round(this.qualityResult.recognition_probability * 100);
        },

        formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },

        showToast(message, type = 'info') {
            if (this.$root.showToast) {
                this.$root.showToast(message, type);
            }
        }
    }
}

// Video uploader component
function videoUploader() {
    return {
        selectedFile: null,
        previewUrl: null,
        uploading: false,
        dragOver: false,
        
        init() {
            // Initialize with existing video if editing
            if (this.$root.arContent && this.$root.arContent.video_url) {
                this.previewUrl = this.$root.arContent.video_url;
            }
        },
        
        triggerFileInput() {
            this.$refs.fileInput.click();
        },
        
        handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                this.processFile(file);
            }
        },
        
        handleDrop(event) {
            this.dragOver = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                this.processFile(files[0]);
            }
        },
        
        processFile(file) {
            // Validate file type
            if (!file.type.startsWith('video/')) {
                this.$dispatch('video-selected', false);
                this.showToast('Пожалуйста, выберите видеофайл', 'error');
                return;
            }
            
            // Validate file size (100MB)
            if (file.size > 100 * 1024 * 1024) {
                this.$dispatch('video-selected', false);
                this.showToast('Размер файла не должен превышать 100MB', 'error');
                return;
            }
            
            this.selectedFile = file;
            this.previewUrl = URL.createObjectURL(file);
            this.$dispatch('video-selected', true);
        },
        
        removeFile() {
            const existingUrl = (this.$root.arContent && this.$root.arContent.video_url)
                ? this.$root.arContent.video_url
                : null;

            this.selectedFile = null;
            if (this.previewUrl && this.previewUrl.startsWith('blob:')) {
                URL.revokeObjectURL(this.previewUrl);
            }
            this.previewUrl = existingUrl;
            this.$refs.fileInput.value = '';
            this.$dispatch('video-selected', false);
        },
        
        formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },
        
        showToast(message, type = 'info') {
            if (this.$root.showToast) {
                this.$root.showToast(message, type);
            }
        }
    }
}
</script>
{% endblock %}