{% extends "base.html" %}

{% block title %}{% if ar_content and ar_content.id %}Edit AR Content - Vertex AR Admin{% else %}Create AR Content - Vertex AR Admin{% endif %}{% endblock %}
{% block page_title %}{% if ar_content and ar_content.id %}Edit AR Content{% else %}Create AR Content{% endif %}{% endblock %}

{% block content %}
<div x-data="arContentForm({% if ar_content %}{{ ar_content|tojson }}{% else %}{}{% endif %}, {{ companies_js|tojson }}, {{ projects_js|tojson }})">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                {% if ar_content and ar_content.id %}Редактировать AR контент{% else %}Создать AR контент{% endif %}
            </h1>
            <a href="{% if ar_content %}/ar-content/{{ ar_content.id }}{% else %}/ar-content{% endif %}" class="btn btn-secondary">
                <span class="material-icons mr-2">arrow_back</span>Назад
            </a>
        </div>

        <form @submit.prevent="handleSubmit" method="post" enctype="multipart/form-data" class="bg-white dark:bg-gray-800 shadow rounded-lg">
            <!-- Company & Project Selection -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Компания и проект</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="company_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Компания <span class="text-red-500">*</span>
                        </label>
                        <select name="company_id" id="company_id" 
                                class="form-input"
                                x-model="formData.company_id"
                                @change="updateProjects"
                                required>
                            <option value="">Выберите компанию</option>
                            {% for company in companies %}
                            <option value="{{ company.id }}">{{ company.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label for="project_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Проект <span class="text-red-500">*</span>
                        </label>
                        <select name="project_id" id="project_id" 
                                class="form-input"
                                x-model="formData.project_id"
                                required>
                            <option value="">Выберите проект</option>
                            <template x-for="project in filteredProjects" :key="project.id">
                                <option :value="project.id" x-text="project.name"></option>
                            </template>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Customer Information -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Информация о заказчике</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="customer_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Имя заказчика
                        </label>
                        <input type="text" name="customer_name" id="customer_name" 
                               class="form-input"
                               x-model="formData.customer_name"
                               placeholder="Имя Фамилия">
                    </div>
                    
                    <div>
                        <label for="customer_phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Телефон
                        </label>
                        <input type="tel" name="customer_phone" id="customer_phone" 
                               class="form-input"
                               x-model="formData.customer_phone"
                               placeholder="+7 (999) 123-45-67">
                    </div>
                    
                    <div>
                        <label for="customer_email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Email
                        </label>
                        <input type="email" name="customer_email" id="customer_email" 
                               class="form-input"
                               x-model="formData.customer_email"
                               placeholder="customer@example.com">
                    </div>
                </div>
            </div>

            <!-- Duration -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Длительность доступа</h3>
                <div>
                    <label for="duration_years" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Период действия <span class="text-red-500">*</span>
                    </label>
                    <select name="duration_years" id="duration_years" 
                            class="form-input"
                            x-model="formData.duration_years"
                            required>
                        <option value="1">1 год</option>
                        <option value="3">3 года</option>
                        <option value="5">5 лет</option>
                    </select>
                </div>
            </div>

            <!-- File Upload -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Файлы контента</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Photo Upload -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Портрет (изображение) <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <div class="photo-upload-area"
                                 x-data="photoUploader()"
                                 x-init="init()"
                                 @click="triggerFileInput()"
                                 @dragover.prevent="dragOver = true"
                                 @dragleave.prevent="dragOver = false"
                                 @drop.prevent="handleDrop($event)"
                                 :class="dragOver ? 'border-blue-400 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-300 dark:border-gray-600'"
                                 class="relative cursor-pointer rounded-lg border-2 border-dashed p-6 text-center hover:border-gray-400 dark:hover:border-gray-500 transition-all duration-200">
                                
                                <!-- Hidden file input -->
                                <input type="file" 
                                       x-ref="fileInput" 
                                       accept="image/*" 
                                       @change="handleFileSelect($event)"
                                       class="hidden">
                                
                                <!-- Upload icon and text -->
                                <div x-show="!selectedFile" class="space-y-2">
                                    <div class="text-gray-400">
                                        <span class="material-icons text-4xl">cloud_upload</span>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        <span class="font-medium text-indigo-600 dark:text-indigo-400">Нажмите для выбора</span> или перетащите файл сюда
                                    </p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">
                                        PNG, JPG до 10MB
                                    </p>
                                </div>
                                
                                <!-- Preview area -->
                                <div x-show="selectedFile" class="space-y-3">
                                    <div class="relative inline-block">
                                        <img :src="previewUrl" 
                                             alt="Preview" 
                                             class="mx-auto h-32 w-32 object-cover rounded-lg border border-gray-300 dark:border-gray-600">
                                        <button type="button"
                                                @click.stop="removeFile()"
                                                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors">
                                            <span class="material-icons text-sm">close</span>
                                        </button>
                                    </div>
                                    <div class="text-sm">
                                        <p class="font-medium text-gray-900 dark:text-white" x-text="selectedFile.name"></p>
                                        <p class="text-gray-500 dark:text-gray-400" x-text="formatFileSize(selectedFile.size)"></p>
                                    </div>
                                </div>
                                
                                <!-- Loading overlay -->
                                <div x-show="uploading" 
                                     x-transition:enter="transition-opacity duration-300"
                                     x-transition:enter-start="opacity-0"
                                     x-transition:enter-end="opacity-100"
                                     x-transition:leave="transition-opacity duration-300"
                                     x-transition:leave-start="opacity-100"
                                     x-transition:leave-end="opacity-0"
                                     class="absolute inset-0 bg-white/80 dark:bg-gray-900/80 rounded-lg flex items-center justify-center">
                                    <div class="text-center">
                                        <span class="material-icons text-3xl text-blue-500 animate-spin">refresh</span>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Загрузка...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Video Upload -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Видео <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <div class="video-upload-area"
                                 x-data="videoUploader()"
                                 x-init="init()"
                                 @click="triggerFileInput()"
                                 @dragover.prevent="dragOver = true"
                                 @dragleave.prevent="dragOver = false"
                                 @drop.prevent="handleDrop($event)"
                                 :class="dragOver ? 'border-blue-400 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-300 dark:border-gray-600'"
                                 class="relative cursor-pointer rounded-lg border-2 border-dashed p-6 text-center hover:border-gray-400 dark:hover:border-gray-500 transition-all duration-200">
                                
                                <!-- Hidden file input -->
                                <input type="file" 
                                       x-ref="fileInput" 
                                       accept="video/*" 
                                       @change="handleFileSelect($event)"
                                       class="hidden">
                                
                                <!-- Upload icon and text -->
                                <div x-show="!selectedFile" class="space-y-2">
                                    <div class="text-gray-400">
                                        <span class="material-icons text-4xl">videocam</span>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        <span class="font-medium text-indigo-600 dark:text-indigo-400">Нажмите для выбора</span> или перетащите файл сюда
                                    </p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">
                                        MP4, WebM, MOV до 100MB
                                    </p>
                                </div>
                                
                                <!-- Preview area -->
                                <div x-show="selectedFile" class="space-y-3">
                                    <div class="relative inline-block">
                                        <video :src="previewUrl" 
                                               class="mx-auto h-32 w-32 object-cover rounded-lg border border-gray-300 dark:border-gray-600"
                                               controls></video>
                                        <button type="button"
                                                @click.stop="removeFile()"
                                                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors">
                                            <span class="material-icons text-sm">close</span>
                                        </button>
                                    </div>
                                    <div class="text-sm">
                                        <p class="font-medium text-gray-900 dark:text-white" x-text="selectedFile.name"></p>
                                        <p class="text-gray-500 dark:text-gray-400" x-text="formatFileSize(selectedFile.size)"></p>
                                    </div>
                                </div>
                                
                                <!-- Loading overlay -->
                                <div x-show="uploading" 
                                     x-transition:enter="transition-opacity duration-300"
                                     x-transition:enter-start="opacity-0"
                                     x-transition:enter-end="opacity-100"
                                     x-transition:leave="transition-opacity duration-300"
                                     x-transition:leave-start="opacity-100"
                                     x-transition:leave-end="opacity-0"
                                     class="absolute inset-0 bg-white/80 dark:bg-gray-900/80 rounded-lg flex items-center justify-center">
                                    <div class="text-center">
                                        <span class="material-icons text-3xl text-blue-500 animate-spin">refresh</span>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Загрузка...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status (only for edit) -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700" x-show="arContent && arContent.id">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Статус</h3>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Статус заказа
                    </label>
                    <select name="status" id="status" 
                            class="form-input"
                            x-model="formData.status">
                        <option value="pending">В ожидании</option>
                        <option value="processing">В обработке</option>
                        <option value="ready">Готов</option>
                        <option value="failed">Ошибка</option>
                    </select>
                </div>
            </div>

            <!-- Actions -->
            <div class="p-6 bg-gray-50 dark:bg-gray-700 rounded-b-lg">
                <div class="flex justify-end space-x-3">
                    <a href="{% if ar_content %}/ar-content/{{ ar_content.id }}{% else %}/ar-content{% endif %}" class="btn btn-secondary">
                        Отмена
                    </a>
                    <button type="submit" 
                            :disabled="!isValid || submitting"
                            :class="{'opacity-50 cursor-not-allowed': !isValid || submitting}"
                            class="btn btn-primary">
                        <span class="material-icons mr-2" x-show="!submitting">save</span>
                        <span class="material-icons mr-2 animate-spin" x-show="submitting">refresh</span>
                        <span x-show="!submitting">{% if ar_content and ar_content.id %}Обновить{% else %}Создать{% endif %} AR контент</span>
                        <span x-show="submitting">Сохранение...</span>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// Photo uploader component
function photoUploader() {
    return {
        selectedFile: null,
        previewUrl: null,
        uploading: false,
        dragOver: false,
        
        init() {
            // Initialize with existing photo if editing
            if (window.arContentFormInstance && window.arContentFormInstance.arContent && window.arContentFormInstance.arContent.photo_url) {
                this.previewUrl = window.arContentFormInstance.arContent.photo_url;
            }
        },
        
        triggerFileInput() {
            this.$refs.fileInput.click();
        },
        
        handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                this.processFile(file);
            }
        },
        
        handleDrop(event) {
            this.dragOver = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                this.processFile(files[0]);
            }
        },
        
        processFile(file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                this.showToast('Пожалуйста, выберите изображение', 'error');
                return;
            }
            
            // Validate file size (10MB)
            if (file.size > 10 * 1024 * 1024) {
                this.showToast('Размер файла не должен превышать 10MB', 'error');
                return;
            }
            
            this.selectedFile = file;
            this.previewUrl = URL.createObjectURL(file);
            
            // Update parent form data
            if (window.arContentFormInstance) {
                window.arContentFormInstance.formData.photo_file = file;
            }
        },
        
        removeFile() {
            this.selectedFile = null;
            if (this.previewUrl && this.previewUrl.startsWith('blob:')) {
                URL.revokeObjectURL(this.previewUrl);
            }
            this.previewUrl = null;
            this.$refs.fileInput.value = '';
            
            // Update parent form data
            if (window.arContentFormInstance) {
                window.arContentFormInstance.formData.photo_file = null;
            }
        },
        
        formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },
        
        showToast(message, type = 'info') {
            if (window.arContentFormInstance) {
                window.arContentFormInstance.showToast(message, type);
            }
        }
    }
}

// Video uploader component
function videoUploader() {
    return {
        selectedFile: null,
        previewUrl: null,
        uploading: false,
        dragOver: false,
        
        init() {
            // Initialize with existing video if editing
            if (window.arContentFormInstance && window.arContentFormInstance.arContent && window.arContentFormInstance.arContent.video_url) {
                this.previewUrl = window.arContentFormInstance.arContent.video_url;
            }
        },
        
        triggerFileInput() {
            this.$refs.fileInput.click();
        },
        
        handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                this.processFile(file);
            }
        },
        
        handleDrop(event) {
            this.dragOver = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                this.processFile(files[0]);
            }
        },
        
        processFile(file) {
            // Validate file type
            if (!file.type.startsWith('video/')) {
                this.showToast('Пожалуйста, выберите видеофайл', 'error');
                return;
            }
            
            // Validate file size (100MB)
            if (file.size > 100 * 1024 * 1024) {
                this.showToast('Размер файла не должен превышать 100MB', 'error');
                return;
            }
            
            this.selectedFile = file;
            this.previewUrl = URL.createObjectURL(file);
            
            // Update parent form data
            if (window.arContentFormInstance) {
                window.arContentFormInstance.formData.video_file = file;
            }
        },
        
        removeFile() {
            this.selectedFile = null;
            if (this.previewUrl && this.previewUrl.startsWith('blob:')) {
                URL.revokeObjectURL(this.previewUrl);
            }
            this.previewUrl = null;
            this.$refs.fileInput.value = '';
            
            // Update parent form data
            if (window.arContentFormInstance) {
                window.arContentFormInstance.formData.video_file = null;
            }
        },
        
        formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },
        
        showToast(message, type = 'info') {
            if (window.arContentFormInstance) {
                window.arContentFormInstance.showToast(message, type);
            }
        }
    }
}

function arContentForm(arContent = {}, companies = [], projects = []) {
    // Store instance globally for child components
    window.arContentFormInstance = this;
    
    return {
        arContent: arContent,
        companies: companies,
        projects: projects,
        submitting: false,
        formData: {
            company_id: arContent.company_id || '',
            project_id: arContent.project_id || '',
            customer_name: arContent.customer_name || '',
            customer_phone: arContent.customer_phone || '',
            customer_email: arContent.customer_email || '',
            duration_years: arContent.duration_years || '1',
            photo_file: null,
            video_file: null,
            status: arContent.status || 'pending'
        },
        
        get filteredProjects() {
            if (!this.formData.company_id) return [];
            return this.projects.filter(project => {
                // Convert both to strings for comparison to handle type mismatches
                const projectCompanyId = String(project.company_id);
                const selectedCompanyId = String(this.formData.company_id);
                console.log(`Filtering project: ${project.name} (company_id: ${projectCompanyId}) vs selected: ${selectedCompanyId}`);
                return project.company_id && this.formData.company_id && projectCompanyId === selectedCompanyId;
            });
        },
        
        get isValid() {
            // Для новых записей требуем наличие файлов
            if (!this.arContent || !this.arContent.id) {
                const isValid = this.formData.company_id &&
                       this.formData.project_id &&
                       this.formData.customer_name &&
                       this.formData.duration_years &&
                       this.formData.photo_file &&
                       this.formData.video_file;
                
                // Debug validation state
                console.log('Validation state for new AR content:', {
                    company_id: this.formData.company_id,
                    project_id: this.formData.project_id,
                    customer_name: this.formData.customer_name,
                    duration_years: this.formData.duration_years,
                    photo_file: this.formData.photo_file,
                    video_file: this.formData.video_file,
                    isValid: isValid
                });
                
                return isValid;
            } else {
                // Для редактирования разрешаем сохранение без новых файлов, если уже есть существующие
                const hasPhoto = this.formData.photo_file || (this.arContent && this.arContent.photo_url);
                const hasVideo = this.formData.video_file || (this.arContent && this.arContent.video_url);
                
                const isValid = this.formData.company_id &&
                       this.formData.project_id &&
                       this.formData.customer_name &&
                       this.formData.duration_years &&
                       hasPhoto &&
                       hasVideo;
                
                // Debug validation state for edit
                console.log('Validation state for edit AR content:', {
                    company_id: this.formData.company_id,
                    project_id: this.formData.project_id,
                    customer_name: this.formData.customer_name,
                    duration_years: this.formData.duration_years,
                    hasPhoto: hasPhoto,
                    hasVideo: hasVideo,
                    photo_file: this.formData.photo_file,
                    video_file: this.formData.video_file,
                    existing_photo_url: this.arContent && this.arContent.photo_url,
                    existing_video_url: this.arContent && this.arContent.video_url,
                    isValid: isValid
                });
                
                return isValid;
            }
        },
        
        updateProjects() {
            // Reset project selection when company changes
            this.formData.project_id = '';
            
            // Debug company selection and available projects
            console.log('Company selection changed:', {
                selected_company_id: this.formData.company_id,
                total_projects: this.projects.length,
                filtered_projects: this.filteredProjects.length
            });
            
            // Log all projects for debugging
            console.log('All available projects:', this.projects);
            console.log('Filtered projects:', this.filteredProjects);
        },
        
        async handleSubmit() {
            if (!this.isValid) {
                this.showToast('Пожалуйста, заполните все обязательные поля', 'error');
                return;
            }
            
            this.submitting = true;
            
            try {
                const formData = new FormData();
                formData.append('company_id', this.formData.company_id);
                formData.append('project_id', this.formData.project_id);
                formData.append('customer_name', this.formData.customer_name);
                formData.append('customer_phone', this.formData.customer_phone);
                formData.append('customer_email', this.formData.customer_email);
                formData.append('duration_years', this.formData.duration_years);
                
                // Добавляем файлы только если они были выбраны
                if (this.formData.photo_file) {
                    formData.append('photo_file', this.formData.photo_file);
                }
                if (this.formData.video_file) {
                    formData.append('video_file', this.formData.video_file);
                }
                
                if (this.arContent && this.arContent.id) {
                    // Update existing AR content
                    formData.append('_method', 'PUT');
                    
                    const response = await fetch(`/companies/${this.formData.company_id}/projects/${this.formData.project_id}/ar-content/${this.arContent.id}`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        this.showToast('AR контент успешно обновлен', 'success');
                        window.location.href = `/ar-content/${this.arContent.id}`;
                    } else {
                        throw new Error('Update failed');
                    }
                } else {
                    // Create new AR content
                    const response = await fetch(`/companies/${this.formData.company_id}/projects/${this.formData.project_id}/ar-content`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.showToast('AR контент успешно создан', 'success');
                        window.location.href = `/ar-content/${result.id}`;
                    } else {
                        throw new Error('Create failed');
                    }
                }
            } catch (error) {
                this.showToast('Не удалось сохранить AR контент', 'error');
                console.error('Submit error:', error);
            } finally {
                this.submitting = false;
            }
        },
        
        showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-4 py-2 rounded shadow z-50`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 3000);
        }
    }
}
</script>
{% endblock %}