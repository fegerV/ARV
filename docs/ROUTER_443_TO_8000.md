# Единый формат ссылок и доступ без порта

Все ссылки (админка, просмотр AR, QR-коды, приложение) берут **один базовый URL** из переменной окружения **`PUBLIC_URL`**.

- В **`.env`** задайте:
  - **С портом (как сейчас):** `PUBLIC_URL=https://ar.neuroimagen.ru:8000`  
    → админка: `https://ar.neuroimagen.ru:8000/admin/login`, ссылки и QR с `:8000`.
  - **Без порта (после настройки 443→8000):** `PUBLIC_URL=https://ar.neuroimagen.ru`  
    → админка: `https://ar.neuroimagen.ru/admin/login`, ссылки и QR без порта.

После смены `PUBLIC_URL` перезапустите сервер. В Android-приложении в `build.gradle.kts` укажите тот же базовый URL в `API_BASE_URL` (с или без `:8000`), чтобы совпадал с `PUBLIC_URL`.

---

# Настройка роутера Keenetic: проброс 443→8000

Чтобы открывать **https://ar.neuroimagen.ru** (без :8000), нужно на роутере настроить переадресацию: внешний порт **443** → ваш ПК, порт **8000**.

---

## Пошагово

1. Откройте веб-интерфейс роутера в браузере: **http://192.168.0.1**
2. В левом меню: **Сетевые правила** → **Переадресация портов**
3. Нажмите **«Добавить правило»**
4. Заполните поля **точно так**:

   | Поле | Значение | Пояснение |
   |------|----------|-----------|
   | **Включить правило** | включено (галочка) | |
   | **Описание** | `ARV HTTPS 443→8000` | для себя |
   | **Вход** | Подключение Ethernet | интерфейс, через который приходит интернет |
   | **Выход** | **Lenovo2** (или имя вашего ПК) | компьютер, где запущен сервер |
   | **Протокол** | **TCP** | |
   | **Тип правила** | Одиночный порт | |
   | **Открыть порт** | **443** | порт снаружи (на него заходят по https://ar.neuroimagen.ru) |
   | **Направлять на порт** | **8000** | порт приложения на ПК |
   | **Расписание** | Работает постоянно | |

5. Нажмите **«Сохранить»**

---

## Важно: не перепутать порты

- **Открыть порт** = **443** (не 8000) — иначе по https://ar.neuroimagen.ru браузер не попадёт на правило.
- **Направлять на порт** = **8000** (не 443) — приложение слушает порт 8000, не 443.

Если указать наоборот (8000 открыть, 443 направлять), сайт без :8000 открываться не будет.

---

## После сохранения

1. В **`.env`** задайте `PUBLIC_URL=https://ar.neuroimagen.ru` (без порта) и пути к SSL:
   - `SSL_KEYFILE=ssl/privkey.pem`
   - `SSL_CERTFILE=ssl/fullchain.pem`
2. **Запускайте сервер с SSL**, иначе ссылки https://ar.neuroimagen.ru/... не откроются (в логах будет «Invalid HTTP request received»):
   - **Рекомендуется:** из корня проекта: `python scripts/run_server.py`
   - Либо: `python -m app.main`
   - Не запускайте через `python -m uvicorn app.main:app ...` без передачи `--ssl-keyfile` и `--ssl-certfile` — тогда на порт 8000 приходит HTTPS, а uvicorn слушает только HTTP.
3. В Android в `API_BASE_URL` укажите `https://ar.neuroimagen.ru`.
4. Откройте в браузере **https://ar.neuroimagen.ru** (без :8000).
5. В брандмауэре Windows разрешите входящее **TCP 8000** (трафик с 443 приходит на ПК на порт 8000).

---

## https://ar.neuroimagen.ru/view/... не открывается с телефона / в приложении

Если в логах сервера много **«Invalid HTTP request received»**, а ссылка без порта не открывается:

- На порт 8000 приходит **HTTPS** (трафик с роутера 443→8000), а uvicorn запущен **без SSL** и ждёт обычный HTTP. Запросы не обрабатываются.
- **Решение:** запускать сервер с SSL (см. выше: `python scripts/run_server.py` или `python -m app.main`). В `.env` должны быть заданы `SSL_KEYFILE` и `SSL_CERTFILE`.

---

## QR с :8000 не открывается с телефона / из приложения

Если в QR зашита ссылка вида **https://ar.neuroimagen.ru:8000/view/...**, с телефона (мобильный интернет) и из приложения она часто не открывается:

- На роутере проброшен только **443 → 8000**. Снаружи доступен только порт **443**, порт **8000** из интернета закрыт.
- Браузер и приложение по QR обращаются к **:8000** и не доходят до сервера.

**Что сделать:**

1. **Рекомендуемый вариант (без порта в ссылках)**  
   - В `.env` уже стоит `PUBLIC_URL=https://ar.neuroimagen.ru` (без порта).  
   - **Новые** QR-коды будут вести на `https://ar.neuroimagen.ru/view/...` (порт 443) и будут открываться с телефона.  
   - Для контента с `unique_id` из старого QR откройте вручную:  
     `https://ar.neuroimagen.ru/view/2c0d6240-43a3-4715-87f6-fab131baf541` (без `:8000`).  
   - В приложении в `API_BASE_URL` укажите `https://ar.neuroimagen.ru` (без порта). Перевыпустите QR без порта (пересоздайте/скачайте QR в админке для этого контента).

2. **Если нужно, чтобы старые QR с :8000 работали**  
   - На роутере добавьте второе правило: **открыть порт 8000** → направлять на ПК, порт **8000**.  
   - Убедитесь, что сервер запущен с SSL (`SSL_KEYFILE` и `SSL_CERTFILE` в `.env`), чтобы на 8000 отдавался HTTPS.  
   - В брандмауэре Windows разрешите входящее **TCP 8000**.
