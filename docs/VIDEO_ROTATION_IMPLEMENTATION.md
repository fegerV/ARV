# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —Ä–æ—Ç–∞—Ü–∏–∏ –≤–∏–¥–µ–æ

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

#### ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `rotation_state` –≤ ARContent
- **–ú–æ–¥–µ–ª—å**: `app/models/ar_content.py`
- **–ú–∏–≥—Ä–∞—Ü–∏—è**: `alembic/versions/20260127_1200_add_rotation_state_to_ar_content.py`
- **–ü–æ–ª–µ**: `rotation_state = Column(Integer, default=0, nullable=True)`

#### ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–∞ –º–æ–¥–µ–ª—å VideoRotationSchedule
- **–§–∞–π–ª**: `app/models/video_rotation_schedule.py`
- **–ù–æ–≤—ã–µ –ø–æ–ª—è**:
  - `default_video_id` - –æ—Å–Ω–æ–≤–Ω–æ–µ –≤–∏–¥–µ–æ
  - `date_rules` (JSONB) - –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞—Ç—ã —Å –≤–∏–¥–µ–æ
  - `random_seed` - seed –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–∞–Ω–¥–æ–º–∞
  - `no_repeat_days` - –¥–Ω–∏ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
  - `next_change_at` - —Å–ª–µ–¥—É—é—â–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
  - `notify_before_expiry_days` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ N –¥–Ω–µ–π
- **–ú–∏–≥—Ä–∞—Ü–∏—è**: `alembic/versions/20260127_1300_extend_video_rotation_schedule.py`

#### ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–∞ –º–æ–¥–µ–ª—å Video
- **–§–∞–π–ª**: `app/models/video.py`
- **–ù–æ–≤—ã–µ –ø–æ–ª—è**:
  - `rotation_weight` - –≤–µ—Å –¥–ª—è —Ä–∞–Ω–¥–æ–º–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
  - `is_default` - –ø–æ–º–µ—Ç–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≤–∏–¥–µ–æ
- **–ú–∏–≥—Ä–∞—Ü–∏—è**: `alembic/versions/20260127_1310_add_video_rotation_fields.py`

### 2. –û–±–Ω–æ–≤–ª–µ–Ω video_scheduler.py

#### ‚úÖ –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏:
1. **Date-specific rules** (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞—Ç—ã) - –≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
2. **VideoSchedule** (–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫–Ω–∞)
3. **VideoRotationSchedule** (–Ω–æ–≤—ã–µ —Ç–∏–ø—ã —Ä–æ—Ç–∞—Ü–∏–∏)
4. **ARContent.active_video_id** (–∞–∫—Ç–∏–≤–Ω–æ–µ –≤–∏–¥–µ–æ)
5. **Legacy rotation** (—Å—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞)
6. **Fallback** (–ª—é–±–æ–µ –∞–∫—Ç–∏–≤–Ω–æ–µ –≤–∏–¥–µ–æ)

#### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–∏–ø—ã —Ä–æ—Ç–∞—Ü–∏–∏:

**1. `fixed`** - –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ
```python
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç default_video_id
```

**2. `date_specific`** - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞—Ç—ã (–ø—Ä–∞–∑–¥–Ω–∏–∫–∏)
```python
date_rules = [
    {"date": "2025-12-31", "video_id": 2, "recurring": true},  # –ö–∞–∂–¥—ã–π –≥–æ–¥
    {"date": "2025-12-25", "video_id": 3, "recurring": false}   # –û–¥–∏–Ω —Ä–∞–∑
]
```

**3. `daily_cycle`** - –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è
```python
# –†–æ—Ç–∞—Ü–∏—è –ø–æ –¥–Ω—é –≥–æ–¥–∞ (1-365)
video_sequence = [1, 2, 3, 4, 5, 6, 7]
```

**4. `weekly_cycle`** - –ü–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏
```python
# –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫=0, –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ=6
video_sequence = [1, 2, 3, 4, 5, 6, 7]
```

**5. `random_daily`** - –†–∞–Ω–¥–æ–º –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
```python
# Seed-based –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏
random_seed = "my_seed"
# –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –¥–µ–Ω—å = –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –≤–∏–¥–µ–æ
```

#### ‚úÖ –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

- `check_date_rules()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–∞—Ç
- `get_daily_cycle_video()` - –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è
- `get_weekly_cycle_video()` - –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏
- `get_random_daily_video()` - —Ä–∞–Ω–¥–æ–º —Å seed
- `get_rotation_rule()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ —Ä–æ—Ç–∞—Ü–∏–∏
- `get_active_video()` - –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π override_date –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 3. –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã:
- `rotation_type` –Ω–∞ —É—Ä–æ–≤–Ω–µ Video (none, sequential, cyclic)
- `rotation_state` –≤ ARContent
- –§—É–Ω–∫—Ü–∏—è `get_next_rotation_video()` –¥–ª—è legacy –∫–æ–¥–∞

## üìã –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è (1 –≤–∏–¥–µ–æ, 3 –≥–æ–¥–∞)
```python
rule = VideoRotationSchedule(
    ar_content_id=1,
    rotation_type="fixed",
    default_video_id=1,
    is_active=True
)
```

### –ü—Ä–∏–º–µ—Ä 2: –°–µ–∑–æ–Ω–Ω–∞—è –∑–∞–º–µ–Ω–∞ (–ø—Ä–∞–∑–¥–Ω–∏–∫–∏)
```python
rule = VideoRotationSchedule(
    ar_content_id=1,
    rotation_type="date_specific",
    default_video_id=1,  # –û—Å–Ω–æ–≤–Ω–æ–µ –≤–∏–¥–µ–æ
    date_rules=[
        {"date": "2025-12-31", "video_id": 2, "recurring": True},  # –ù–æ–≤—ã–π –≥–æ–¥
        {"date": "2025-12-25", "video_id": 3, "recurring": True},  # –†–æ–∂–¥–µ—Å—Ç–≤–æ
    ],
    is_active=True
)
```

### –ü—Ä–∏–º–µ—Ä 3: –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è (7 –≤–∏–¥–µ–æ)
```python
rule = VideoRotationSchedule(
    ar_content_id=1,
    rotation_type="daily_cycle",
    video_sequence=[1, 2, 3, 4, 5, 6, 7],
    is_active=True
)
```

### –ü—Ä–∏–º–µ—Ä 4: –ü–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏
```python
rule = VideoRotationSchedule(
    ar_content_id=1,
    rotation_type="weekly_cycle",
    video_sequence=[1, 2, 3, 4, 5, 6, 7],  # –ü–Ω-–í—Å
    is_active=True
)
```

### –ü—Ä–∏–º–µ—Ä 5: –†–∞–Ω–¥–æ–º –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
```python
rule = VideoRotationSchedule(
    ar_content_id=1,
    rotation_type="random_daily",
    video_sequence=[1, 2, 3, 4, 5, 6, 7],
    random_seed="my_unique_seed",
    is_active=True
)
```

## üîÑ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–∞–≤–∏–ª

–ü—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–∏–¥–µ–æ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Ä—è–¥–∫–µ:

1. **Date rules** (date_specific) - –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ –≤—Å–µ–≥–æ
2. **VideoSchedule** (–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫–Ω–∞)
3. **VideoRotationSchedule** (–ø–æ —Ç–∏–ø—É —Ä–æ—Ç–∞—Ü–∏–∏)
4. **active_video_id** (–µ—Å–ª–∏ –Ω–µ –∏—Å—Ç–µ–∫)
5. **Legacy rotation** (—Å—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞)
6. **Fallback** (–ª—é–±–æ–µ –∞–∫—Ç–∏–≤–Ω–æ–µ)

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `override_date`:

```python
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∫–æ–µ –≤–∏–¥–µ–æ –±—É–¥–µ—Ç 31 –¥–µ–∫–∞–±—Ä—è
result = await get_active_video(
    ar_content_id=1, 
    db=db, 
    override_date=date(2025, 12, 31)
)
```

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è - **–í–´–ü–û–õ–ù–ï–ù–û**
2. ‚úÖ –ù–æ–≤—ã–µ —Ç–∏–ø—ã —Ä–æ—Ç–∞—Ü–∏–∏ - **–í–´–ü–û–õ–ù–ï–ù–û**
3. ‚è≥ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ 7 –¥–Ω–µ–π - **TODO**
4. ‚è≥ UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º - **TODO**
5. ‚è≥ API –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è - **TODO**

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ú–∏–≥—Ä–∞—Ü–∏–∏**: –í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º:
   ```bash
   alembic upgrade head
   ```

2. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞ (rotation_type –Ω–∞ Video) –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

3. **Date rules —Ñ–æ—Ä–º–∞—Ç**: 
   - `recurring: true` - –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –≥–æ–¥
   - `recurring: false` - —Ç–æ–ª—å–∫–æ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∞—Ç—ã

4. **Random seed**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π seed –¥–ª—è –∫–∞–∂–¥–æ–≥–æ AR –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏
