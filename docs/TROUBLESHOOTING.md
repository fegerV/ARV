# Руководство по решению проблем

Документация по решению распространенных проблем в платформе ARV.

## Содержание

1. [Не удаётся установить соединение с сайтом](#не-удаётся-установить-соединение-с-сайтом)
2. [Проблемы с базой данных](#проблемы-с-базой-данных)
3. [Проблемы с аутентификацией](#проблемы-с-аутентификацией)
4. [Проблемы с генерацией маркеров](#проблемы-с-генерацией-маркеров)
5. [Проблемы с Docker](#проблемы-с-docker)
6. [Проблемы с API](#проблемы-с-api)
7. [Проблемы с файлами и хранилищем](#проблемы-с-файлами-и-хранилищем)
8. [Проблемы с AR Viewer](#проблемы-с-ar-viewer)

**Доступ к ar.neuroimagen.ru** — без тоннеля: используется прямой проброс порта на роутере (443→8000 или 8000→8000). Тоннель (ngrok) не используется. При необходимости тестировать через ngrok см. [docs/NGROK_TESTING.md](NGROK_TESTING.md).

## Не удаётся установить соединение с сайтом

**Симптомы:** при открытии https://ar.neuroimagen.ru/ или https://ar.neuroimagen.ru/admin/ браузер пишет «Не удаётся установить соединение», «Время ожидания ответа истекло».

Это значит, что запрос до сервера не доходит (сеть/файрвол/DNS/порты). Ссылки на AR-контент (публичная ссылка и QR) формируются как `https://ar.neuroimagen.ru/view/{unique_id}` — если по этой ссылке таймаут, устраняйте доступность по тому же чеклисту ниже.

Проверьте по шагам:

### 1. Сервер запущен

На машине, куда указывает домен, должен работать процесс приложения:

```bash
# из корня проекта
python -m app.main
```

В логе должно быть: `Uvicorn running on https://0.0.0.0:8000`.

### 2. Доступность с той же машины

На сервере выполните:

```bash
curl -k https://localhost:8000/api/health/status
# или
curl -k https://127.0.0.1:8000/admin/
```

Если здесь таймаут — приложение не слушает порт или не запущено. Если ответ 200 — приложение работает, проблема снаружи.

### 3. Порт и проброс

- Приложение слушает **порт 8000** (HTTPS при заданных SSL_KEYFILE/SSL_CERTFILE в `.env`).
- Снаружи обычно заходят по **443**. Нужно либо:
  - **Проброс порта:** на роутере/хосте пробросить внешний 443 → этот компьютер:8000, или
  - **Reverse proxy (nginx/caddy):** на 443 слушает nginx, проксирует на `https://127.0.0.1:8000`.

Проверьте, что правило проброса/прокси действительно ведёт на машину, где запущен `python -m app.main`.

### 4. Файрвол

На сервере разрешите входящие:

- **8000** — если снаружи стучатся сразу на 8000, или  
- **443** — если снаружи стучатся на 443, а до приложения трафик доводит nginx/проброс.

Пример (Windows): «Брандмауэр Windows» → Доп. параметры → Правила для входящих → разрешить TCP 8000 (или 443).

### 5. DNS

Убедитесь, что `ar.neuroimagen.ru` указывает на IP той машины, где запущен сервер:

```bash
nslookup ar.neuroimagen.ru
# или
ping ar.neuroimagen.ru
```

Если IP другой (другой хост/облако) — там и нужно запускать приложение или править DNS.

### Краткий чеклист

| Проверка | Команда / действие |
|----------|--------------------|
| Сервер запущен | `python -m app.main` в терминале, в логе есть `Uvicorn running on https://0.0.0.0:8000` |
| Локально отвечает | `curl -k https://127.0.0.1:8000/api/health/status` возвращает JSON |
| Порт открыт | Проброс 443→8000 или nginx на 443 → localhost:8000 |
| Файрвол | Входящий TCP 8000 или 443 разрешён |
| DNS | `ar.neuroimagen.ru` резолвится в IP этой машины |

### Проброс 443→8000 на роутере Keenetic (чтобы открывать https://ar.neuroimagen.ru без :8000)

1. Откройте веб-интерфейс роутера: **http://192.168.0.1** (или ваш адрес).
2. В меню: **Сетевые правила** → **Переадресация портов**.
3. Нажмите **«Добавить правило»** (или откройте создание нового).
4. Заполните:
   - **Включить правило** — включено.
   - **Описание** — например: `ARV HTTPS 443→8000`.
   - **Вход** — «Подключение Ethernet» (или интерфейс, через который приходит интернет).
   - **Выход** — выберите ваш ПК (например **Lenovo2**), куда пробрасываем.
   - **Протокол** — **TCP**.
   - **Тип правила** — «Одиночный порт».
   - **Открыть порт** — **443** (внешний порт, на который заходят по https://ar.neuroimagen.ru).
   - **Направлять на порт** — **8000** (порт, на котором слушает приложение).
   - **Расписание** — «Работает постоянно».
5. Нажмите **«Сохранить»**.

После этого https://ar.neuroimagen.ru (без :8000) должен открываться. В брандмауэре Windows разрешите входящий **TCP 443** для этого ПК. В `.env` можно вернуть `PUBLIC_URL=https://ar.neuroimagen.ru` (без порта).

### «Страница недоступна» при открытии https://ar.neuroimagen.ru/

Если после настройки проброса 443→8000 по-прежнему «Страница недоступна» или «Ошибка соединения», проверьте по шагам:

1. **Правило на роутере:** правило 443→8000 включено и сохранено; в поле **Выход** выбран именно этот ПК (Lenovo2). Если ПК получает IP по DHCP, в роутере лучше зарезервировать IP за этим устройством или указать правило по IP, а не по имени.
2. **Брандмауэр Windows — разрешить входящий TCP 443:**
   - Вариант через GUI: Панель управления → Брандмауэр Windows → Дополнительные параметры → Правила для входящих подключений → Создать правило → Тип: для порта → TCP, порт **443** → Разрешить подключение → Имя, например: «ARV HTTPS 443».
   - Вариант из PowerShell (запустить от имени администратора):
   ```powershell
   New-NetFirewallRule -DisplayName "ARV HTTPS 443" -Direction Inbound -Protocol TCP -LocalPort 443 -Action Allow
   ```
3. **Сервер запущен:** на этом ПК выполните `python -m app.main`; в логе должно быть `Uvicorn running on https://0.0.0.0:8000`.
4. **Локально отвечает:** в браузере на этом же ПК откройте https://127.0.0.1:8000/admin/ — страница должна открываться. Если локально не открывается, проблема в приложении, а не в роутере.
5. **Проверка снаружи:** откройте https://ar.neuroimagen.ru с телефона по мобильному интернету (не по Wi‑Fi этого же роутера) или попросите кого-то открыть с другого места. Так вы поймёте, блокирует ли соединение роутер/файрвол или проблема на стороне провайдера/DNS.

Если **https://ar.neuroimagen.ru:8000** по-прежнему открывается, а **https://ar.neuroimagen.ru** (порт 443) — нет, значит трафик на 443 не доходит до приложения: проверьте правило проброса 443→8000 и правило брандмауэра для порта **8000** (см. ниже).

**Важно:** при пробросе 443→8000 роутер принимает соединения на свой порт 443 и пересылает их на ваш ПК на порт **8000**. На ПК пакеты приходят уже с портом назначения **8000**, поэтому в брандмауэре Windows нужно разрешить входящий **TCP 8000** (правило для 443 на ПК не используется для этого трафика). Добавьте правило, если его ещё нет:

```powershell
# Запустить от имени администратора
New-NetFirewallRule -DisplayName "ARV HTTPS 8000" -Direction Inbound -Protocol TCP -LocalPort 8000 -Action Allow
```

### Если на этом же компьютере другой проект открывался

Тогда роутер и DNS, скорее всего, настроены. Отличие — **порт приложения**.

- **ARV слушает порт 8000** (HTTPS). В роутере в пробросе портов должно быть:
  - либо **Внешний 443 → этот ПК, порт 8000** (чтобы открывать https://ar.neuroimagen.ru без :8000),
  - либо **Внешний 8000 → этот ПК, порт 8000** (тогда открывать https://ar.neuroimagen.ru:8000).
- Если другой проект слушал, например, **8080 или 80**, правило в роутере было для того порта. Для ARV нужно **отдельное правило для 8000** (или изменить существующее на 443→8000 / 8000→8000).
- **Брандмауэр Windows:** правило «Входящие» могло быть создано для другого порта (8080, 3000 и т.д.). Добавьте правило для **TCP 8000** (или 443, если снаружи заходят по 443) на этот компьютер.

**Проверка порта и IP (PowerShell):**

```powershell
# Кто слушает порт 8000
Get-NetTCPConnection -LocalPort 8000 -State Listen -ErrorAction SilentlyContinue | Select-Object LocalAddress, LocalPort, State

# Локальный IP этого ПК (для проброса в роутере)
Get-NetIPAddress -AddressFamily IPv4 | Where-Object { $_.InterfaceAlias -notmatch 'Loopback' } | Select-Object IPAddress, InterfaceAlias
```

В роутере в пробросе портов должен быть указан именно этот локальный IP и порт **8000**.

### «MINDAR library load timeout» на странице AR-просмотрщика

**Симптомы:** на странице `/view/{unique_id}` появляется сообщение о таймауте загрузки библиотеки MindAR.

**Важно:** доступ к сайту — без тоннеля; **увеличение таймаута не устраняет причину**. Если скрипты не успевают загрузиться за отведённое время, проблема в доступности источников или в сети, а не в длине таймаута.

**Что проверить:**

1. **CDN:** библиотеки по умолчанию грузятся с `cdn.jsdelivr.net`. Откройте в браузере на телефоне (или в эмуляторе) вкладку «Сеть» (Network) и убедитесь, что запросы к `mindar-image.prod.js` и `mindar-image-three.prod.js` завершаются успешно (статус 200). Если CDN блокируется или не открывается — сработает fallback на ваш сервер.
2. **Fallback на свой сервер:** при таймауте просмотрщик повторно пытается загрузить скрипты с `https://ar.neuroimagen.ru/static/js/`. Проверьте, что по адресам `/static/js/mindar-image.prod.js` и `/static/js/mindar-image-three.prod.js` отдаются файлы (откройте их в браузере). Если файлов нет — положите собранные скрипты в каталог `static/js/` (см. [docs/MINDAR_CPU_PATCH.md](MINDAR_CPU_PATCH.md)).
3. **Консоль браузера:** откройте консоль (F12 → Console) на странице просмотрщика и посмотрите ошибки (CORS, блокировка скриптов, сетевые ошибки).
4. **HTTPS:** AR-просмотрщик и доступ к камере работают только по HTTPS. Убедитесь, что открываете ссылку вида `https://ar.neuroimagen.ru/view/...`, а не по http.

### AR не загружается с телефона

**Симптомы:** ссылка `/view/{unique_id}` открывается на телефоне, но AR не запускается — зависает на «Загрузка библиотек AR...», «Подготовка нейросети...» или «Запуск камеры...», либо появляется ошибка.

**Что проверить:**

1. **Открывать в браузере, а не в приложении:** ссылку из QR или мессенджера откройте **«Открыть в браузере»** (Chrome, Safari, Firefox). Встроенный браузер Telegram/мессенджеров часто не даёт доступ к камере или ограничивает WebGL — AR может не заработать.
2. **HTTPS:** в адресной строке должно быть `https://...`. По HTTP камера не разрешается. Используйте ссылку вида `https://ar.neuroimagen.ru:8000/view/...` (с портом, если проброс 8000→8000).
3. **Разрешение камеры:** при нажатии «Запустить камеру» браузер должен запросить доступ. Выберите «Разрешить». Если ранее нажали «Заблокировать» — откройте настройки сайта в браузере и разрешите камеру для этого домена, затем обновите страницу.
4. **Подождать инициализацию:** на телефоне первый запуск нейросети (TensorFlow.js) может занять **1–2 минуты**. Не закрывайте страницу и не переключайте вкладку. Если через 2 минуты всё ещё «Подготовка нейросети...» — обновите страницу и попробуйте снова.
5. **Логи сервера:** в логах приложения должны быть `GET /view/...` 200 и `GET /static/js/mindar-image.prod.js` 200 (или запросы к CDN). Ошибки `ConnectionResetError` после успешной отдачи страницы — норма (клиент закрыл соединение), их можно игнорировать.
6. **Публичная ссылка:** в `.env` задан `PUBLIC_URL=https://ar.neuroimagen.ru:8000` (или ваш домен с портом). По этой ссылке пользователи должны открывать просмотрщик; маркер и видео тогда подгружаются с того же хоста.

Если после всех проверок AR по-прежнему не загружается — откройте на телефоне страницу просмотрщика, включите «Режим разработчика» и посмотрите консоль (Chrome Remote Debugging или Safari Web Inspector) на предмет ошибок камеры, WebGL или сети.

## Проблемы с базой данных

### Ошибка: "Database is locked" (SQLite)

**Симптомы:**
- Приложение не может записать в базу данных
- Ошибки при применении миграций

**Решения:**

1. **Закройте все подключения к БД:**
   ```bash
   # Проверьте активные подключения
   lsof test_vertex_ar.db
   # Или на Windows
   # Закройте все программы, использующие БД
   ```

2. **Используйте PostgreSQL в продакшене:**
   ```bash
   export DATABASE_URL="postgresql+asyncpg://user:pass@host:5432/dbname"
   ```

3. **Перезапустите приложение:**
   ```bash
   docker compose restart
   ```

### Ошибка: "Table does not exist"

**Симптомы:**
- Ошибки при обращении к таблицам
- Миграции не применены

**Решения:**

1. **Примените миграции:**
   ```bash
   alembic upgrade head
   ```

2. **Проверьте текущую версию:**
   ```bash
   alembic current
   ```

3. **Просмотрите историю:**
   ```bash
   alembic history
   ```

### Ошибка при применении миграций

**Симптомы:**
- Миграции не применяются
- Ошибки в логах Alembic

**Решения:**

1. **Проверьте подключение к БД:**
   ```bash
   # Проверьте DATABASE_URL
   echo $DATABASE_URL
   ```

2. **Просмотрите SQL без применения:**
   ```bash
   alembic upgrade head --sql
   ```

3. **Откатите и примените заново:**
   ```bash
   alembic downgrade -1
   alembic upgrade head
   ```

## Проблемы с аутентификацией

### Не могу войти с правильным паролем

**Симптомы:**
- Ошибка "Неверный email или пароль" при правильных данных

**Решения:**

1. **Проверьте тип хеша пароля:**
   ```bash
   python utilities/check_hash_type.py
   ```

2. **Обновите пароль:**
   ```bash
   python utilities/update_password_directly.py
   ```

3. **Сбросьте пароль администратора:**
   ```bash
   python utilities/fix_admin_password.py
   ```

### Аккаунт заблокирован

**Симптомы:**
- Сообщение "Аккаунт временно заблокирован"
- Превышен лимит попыток входа

**Решения:**

1. **Подождите 15 минут** (стандартное время блокировки)

2. **Сбросьте блокировку:**
   ```bash
   python utilities/reset_login_attempts.py
   ```

3. **Или через SQL:**
   ```sql
   UPDATE users SET login_attempts = 0, locked_until = NULL WHERE email = 'admin@vertexar.com';
   ```

### Токен не принимается

**Симптомы:**
- Ошибка 401 Unauthorized при использовании токена
- Токен истек

**Решения:**

1. **Проверьте формат заголовка:**
   ```bash
   Authorization: Bearer <token>
   ```

2. **Проверьте SECRET_KEY:**
   - Должен быть одинаковым на всех серверах
   - Минимум 32 символа

3. **Проверьте время жизни токена:**
   - По умолчанию 24 часа
   - Настройка: `ACCESS_TOKEN_EXPIRE_MINUTES`

4. **Получите новый токен:**
   ```bash
   curl -X POST http://localhost:8000/api/auth/login \
     -d "username=admin@vertexar.com&password=your_password"
   ```

## Проблемы с генерацией маркеров

### Ошибка: "MindAR dependencies not found"

**Симптомы:**
- Ошибка при генерации маркеров
- Сообщение о отсутствующих зависимостях

**Решения:**

1. **Установите Node.js зависимости:**
   ```bash
   npm install
   ```

2. **Проверьте наличие пакетов:**
   ```bash
   ls node_modules/mind-ar
   ls node_modules/canvas
   ```

3. **В Docker:**
   ```dockerfile
   RUN npm install
   ```

### Ошибка: "Marker has no features"

**Симптомы:**
- Маркер создается, но не работает в AR viewer
- Предупреждение о отсутствии features

**Решения:**

1. **Используйте изображение с большим количеством деталей:**
   - Высокий контраст
   - Четкие границы
   - Уникальные паттерны

2. **Увеличьте max_features:**
   ```python
   MINDAR_MAX_FEATURES = 2000  # Вместо 1000
   ```

3. **Проверьте качество изображения:**
   - Минимум 640x480
   - Рекомендуется 1920x1080 или выше
   - Формат: JPEG или PNG

### Ошибка компиляции Node.js

**Симптомы:**
- Ошибки при выполнении mindar_compiler.mjs
- Timeout при генерации

**Решения:**

1. **Проверьте Node.js версию:**
   ```bash
   node --version  # Должна быть >= 18
   ```

2. **Проверьте системные зависимости для canvas:**
   ```bash
   # Ubuntu/Debian
   sudo apt-get install build-essential libcairo2-dev libpango1.0-dev
   
   # macOS
   brew install pkg-config cairo pango
   ```

3. **Увеличьте timeout:**
   - В `mindar_generator.py` timeout = 300 секунд (5 минут)

## Проблемы с Docker

### Контейнер не запускается

**Симптомы:**
- Docker контейнер падает сразу после запуска
- Ошибки в логах

**Решения:**

1. **Проверьте логи:**
   ```bash
   docker compose logs app
   ```

2. **Проверьте переменные окружения:**
   ```bash
   docker compose config
   ```

3. **Пересоберите образ:**
   ```bash
   docker compose build --no-cache
   docker compose up
   ```

### База данных недоступна из контейнера

**Симптомы:**
- Ошибки подключения к БД
- Timeout при подключении

**Решения:**

1. **Проверьте, что PostgreSQL контейнер запущен:**
   ```bash
   docker compose ps
   ```

2. **Проверьте DATABASE_URL:**
   ```bash
   # Должен использовать имя сервиса из docker-compose.yml
   DATABASE_URL=postgresql+asyncpg://user:pass@postgres:5432/dbname
   ```

3. **Проверьте сеть Docker:**
   ```bash
   docker network ls
   docker network inspect arv_default
   ```

### Проблемы с volumes

**Симптомы:**
- Файлы не сохраняются
- Ошибки доступа к файлам

**Решения:**

1. **Проверьте права доступа:**
   ```bash
   ls -la storage/
   ```

2. **Создайте директории:**
   ```bash
   mkdir -p storage/VertexAR
   chmod 755 storage
   ```

3. **Проверьте mount points в docker-compose.yml**

## Проблемы с API

### Ошибка 422: Validation Error

**Симптомы:**
- Запросы отклоняются с ошибкой валидации
- Неверный формат данных

**Решения:**

1. **Проверьте формат данных:**
   - Используйте правильные типы
   - Проверьте обязательные поля

2. **Проверьте документацию API:**
   ```bash
   # Откройте в браузере
   http://localhost:8000/docs
   ```

3. **Используйте примеры из docs/API_EXAMPLES.md**

### Ошибка 500: Internal Server Error

**Симптомы:**
- Внутренние ошибки сервера
- Неожиданные исключения

**Решения:**

1. **Проверьте логи приложения:**
   ```bash
   docker compose logs -f app
   ```

2. **Проверьте подключение к БД:**
   ```bash
   python utilities/check_db.py
   ```

3. **Проверьте доступность хранилища:**
   ```bash
   ls -la storage/
   ```

### CORS ошибки

**Симптомы:**
- Ошибки в браузере при запросах с другого домена
- "CORS policy" в консоли

**Решения:**

1. **Настройте CORS_ORIGINS:**
   ```python
   CORS_ORIGINS = [
       "http://localhost:3000",
       "https://yourdomain.com"
   ]
   ```

2. **Проверьте настройки в config.py**

3. **Для разработки можно разрешить все:**
   ```python
   CORS_ORIGINS = ["*"]  # Только для разработки!
   ```

## Проблемы с файлами и хранилищем

### Файлы не загружаются

**Симптомы:**
- Ошибки при загрузке файлов
- Файлы не сохраняются

**Решения:**

1. **Проверьте права доступа:**
   ```bash
   ls -la storage/
   chmod 755 storage/
   ```

2. **Проверьте размер файлов:**
   - Фото: максимум 10MB
   - Видео: максимум 100MB

3. **Проверьте формат файлов:**
   - Фото: JPEG, PNG
   - Видео: MP4, WebM, MOV

### Файлы не отображаются

**Симптомы:**
- Файлы загружены, но не видны
- Ошибки 404 при доступе к файлам

**Решения:**

1. **Проверьте PUBLIC_URL:**
   ```python
   PUBLIC_URL = "http://localhost:8000"
   ```

2. **Проверьте маршруты статических файлов:**
   ```python
   # В main.py должны быть настроены static routes
   ```

3. **Проверьте путь к файлам:**
   ```bash
   ls -la storage/VertexAR/
   ```

### Недостаточно места на диске

**Симптомы:**
- Ошибки при сохранении файлов
- "No space left on device"

**Решения:**

1. **Проверьте свободное место:**
   ```bash
   df -h
   ```

2. **Очистите старые файлы:**
   ```bash
   # Удалите неиспользуемые файлы
   find storage/ -type f -mtime +30 -delete
   ```

3. **Настройте автоматическую очистку**

## Общие советы

### Просмотр логов

```bash
# Docker
docker compose logs -f app

# Локально
tail -f logs/app.log
```

### Проверка конфигурации

```bash
# Проверьте переменные окружения
env | grep -E "(DATABASE|SECRET|CORS)"

# Проверьте настройки в config.py
python -c "from app.core.config import settings; print(settings.dict())"
```

### Тестирование подключений

```bash
# База данных
python utilities/check_db.py

# Пользователи
python utilities/check_users_and_auth.py

# Миграции
python utilities/check_migration.py
```

### Сброс к начальному состоянию

```bash
# Осторожно! Удалит все данные
rm -rf storage/*
rm test_vertex_ar.db
alembic upgrade head
python utilities/create_admin.py
```

## Проблемы с AR Viewer

Подробная документация: [AR_VIEWER_TROUBLESHOOTING.md](./AR_VIEWER_TROUBLESHOOTING.md)

### Быстрая диагностика

| Ошибка | Причина | Решение |
|--------|---------|---------|
| "Камера не найдена" | Нет камеры | Подключите веб-камеру |
| "Доступ к камере запрещён" | Не дано разрешение | Разрешите камеру в браузере |
| "WebGL недоступен" | Отключено аппаратное ускорение | Включите в настройках браузера |
| Таймаут на `_startAR` | Медленный GPU | Откройте на компьютере |
| "MINDAR: false" | Проблема CDN | Проверьте интернет |

### Диагностический режим

Добавьте `?diagnose=1` к URL:
```
https://ar.neuroimagen.ru/view/xxx-xxx?diagnose=1
```

### Рекомендуемые устройства

- **Компьютер** с веб-камерой — самый надёжный вариант
- **iPhone** — Safari работает хорошо
- **Android** — Chrome, но на слабых GPU может быть медленно

### Версии библиотек

- Three.js: 0.147.0
- MindAR: 1.1.5 (IIFE бандл с CDN)

---

## Получение помощи

Если проблема не решена:

1. Проверьте логи приложения
2. Изучите документацию API: http://localhost:8000/docs
3. Создайте issue в репозитории с описанием проблемы
4. Приложите логи и конфигурацию (без секретных данных)
