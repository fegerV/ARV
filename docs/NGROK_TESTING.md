# Тестирование через ngrok и проверка AR-трекинга

Краткое руководство по тестированию платформы с телефона через ngrok и проверке работы трекинга маркеров (Mind AR).

## Зачем нужен ngrok

- Доступ к приложению с телефона по публичному HTTPS-URL (камера и AR обычно требуют HTTPS или localhost).
- Проверка AR-просмотра и трекинга маркеров на реальном устройстве.

## Шаг 1. Установка ngrok

1. Скачайте ngrok: https://ngrok.com/download  
2. Зарегистрируйтесь и получите authtoken: https://dashboard.ngrok.com/get-started/your-authtoken  
3. Настройте токен: `ngrok config add-authtoken YOUR_TOKEN`

## Шаг 2. Запуск приложения

Приложение должно слушать все интерфейсы (`0.0.0.0`), чтобы ngrok мог к нему подключаться.

**Вариант A — через uvicorn (рекомендуется):**

```bash
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

**Вариант B — через Python:**

```bash
python -m app.main
```

(В `main.py` при запуске через `__main__` используется `host="0.0.0.0"`.)

Убедитесь, что порт 8000 свободен и в логах нет ошибок.

## Шаг 3. Запуск ngrok

В **отдельном** терминале:

```bash
ngrok http 8000
```

В выводе будет строка вида:

```
Forwarding   https://xxxx-xx-xx-xx-xx.ngrok-free.app -> http://localhost:8000
```

Скопируйте этот **https**-URL (например, `https://abc123.ngrok-free.app`).

## Шаг 4. Открытие на смартфоне

1. Убедитесь, что телефон в той же сети, что и компьютер, или используйте мобильный интернет (ngrok доступен извне).
2. Узнайте `unique_id` AR-контента (из админки или API, например список AR-контента).
3. Откройте в браузере на телефоне:

   ```
   https://ВАШ-NGROK-URL/view/UNIQUE_ID
   ```

   Пример: `https://abc123.ngrok-free.app/view/550e8400-e29b-41d4-a716-446655440000`

4. При первом заходе ngrok может показать предупреждение — нажмите «Visit Site».

## Шаг 5. Проверка трекинга

1. **Разрешите доступ к камере** по запросу браузера.
2. **Распечатайте или откройте на другом экране изображение маркера** для выбранного AR-контента (маркер можно скачать в карточке AR-контента в админке).
3. **Наведите камеру телефона на маркер** — должен появиться AR-объект (например, видео поверх маркера).
4. Проверьте:
   - маркер стабильно распознаётся;
   - видео/контент отображается поверх маркера;
   - при уходе камеры с маркера контент исчезает/ставится на паузу;
   - при возврате камеры на маркер контент снова показывается.

## Опционально: QR-код и публичная ссылка

Если нужно, чтобы QR-код вёл на ngrok-URL (например, для теста печатных материалов):

1. В `.env` задайте:
   ```env
   PUBLIC_URL=https://ВАШ-NGROK-URL
   ```
   (без слэша в конце)

2. Перезапустите приложение.

Тогда сгенерированные ссылки и QR-коды будут использовать этот URL. Для разового теста по прямой ссылке `/view/{unique_id}` менять `PUBLIC_URL` не обязательно: страница и ресурсы (маркер, видео) отдаются с того же origin (ngrok), относительные пути `/storage/...` работают.

## Режим диагностики (?diagnose=1)

Если AR на телефоне «висит» на загрузке (спиннер после «Подготовка нейросети»), можно собрать тайминги и понять, на каком этапе зависание.

1. Откройте viewer с параметром: `https://ВАШ-NGROK-URL/view/UNIQUE_ID?diagnose=1`
2. Дождитесь окончания (успешный запуск AR или таймаут).
3. В логах сервера ищите записи `ar_diagnostic` с полями:
   - `event` — этап (`start_begin`, `_startVideo`, `_startAR`, `start_complete`, `start_timeout`, `start_error`);
   - `duration_ms` — длительность этапа в миллисекундах;
   - `user_agent`, `ar_content_unique_id`.

По ним видно:
- пришёл ли хотя бы `start_begin`;
- завершился ли `_startVideo` (камера) и за сколько;
- зависание в `_startAR` (загрузка/парсинг маркера + первый прогон TensorFlow.js) или таймаут без этапов.

Endpoint для приёма событий: `POST /api/analytics/ar-diagnostic` (вызывается автоматически со страницы при `?diagnose=1`).

При таймауте 120 сек пользователь видит уточнённое сообщение: на каком этапе застряло («загрузка камеры или ранняя инициализация» или «инициализация трекинга (нейросеть/маркер)»). Это помогает сопоставить с логами `ar_diagnostic`.

**Известная причина зависания на мобильных:** после этапа камеры (`_startVideo`) MindAR выполняет `_startAR` — загрузка/парсинг маркера и первый прогон TensorFlow.js. На части Android/iOS браузеров WebGL TF.js компилирует шейдеры синхронно и может подвисать или зависать. В viewer до старта MindAR принудительно выставляется CPU-бэкенд TF и делается «прогрев»; если в бандле MindAR используется свой экземпляр tf, зависание может сохраняться. **Вариант решения:** собрать MindAR из исходников с патчем CPU (см. [docs/MINDAR_CPU_PATCH.md](MINDAR_CPU_PATCH.md)) и скрипт `scripts/build_mindar_cpu.py`.

## Возможные проблемы

| Проблема | Решение |
|----------|--------|
| «Connection refused» на телефоне | Убедитесь, что приложение запущено с `--host 0.0.0.0` и ngrok указывает на порт 8000. |
| Камера не включается | Используйте HTTPS-URL ngrok; на части устройств камера в Web AR доступна только по HTTPS. |
| Маркер не распознаётся | Проверьте освещение, резкость и то, что открыт правильный маркер для данного AR-контента. |
| Ошибка CORS при запросах с телефона | Запросы идут на тот же origin (ngrok), CORS не должен мешать. Если добавляете отдельный фронт — укажите ngrok-URL в `CORS_ORIGINS` в настройках. |

## Полезные ссылки

- Список AR-контента (нужен вход): `https://ВАШ-NGROK-URL/ar-content/`  
- Публичный просмотр: `https://ВАШ-NGROK-URL/view/{unique_id}`  
- API активного видео для viewer: `GET /api/viewer/ar/{unique_id}/active-video`
