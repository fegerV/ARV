# Превью, ссылки и QR-код не отображаются

Если в админке на странице AR-контента (список и детали заказа) не показываются превью фото, ссылка для AR-просмотра и QR-код, проверьте по шагам ниже.

## 1. Деплой последнего кода

На сервере в каталоге приложения:

```bash
cd /opt/arv/app
git pull
```

Так подтянутся:
- шаблон детали с **Alpine.store('arContentDetail')** — тогда поля «Ссылка для AR-просмотра» и QR заполняются;
- конфиг Nginx с проксированием `/storage/` и `/favicon.ico` на бэкенд.

## 2. Nginx: отдавать /storage/ и favicon через бэкенд

Чтобы не было **403** на превью и QR, запросы к файлам должны идти в приложение (оно запущено от пользователя с доступом к файлам).

Скопируйте актуальный конфиг и перезагрузите Nginx:

```bash
sudo cp /opt/arv/app/deploy/nginx/arv.conf /etc/nginx/sites-available/arv.conf
sudo nginx -t
sudo systemctl reload nginx
```

В `arv.conf` должны быть блоки:
- `location /storage/ { proxy_pass http://arv_backend; ... }`
- `location = /favicon.ico { proxy_pass http://arv_backend; ... }`

Если вместо этого используется `alias /opt/arv/storage/`, то Nginx отдаёт файлы сам и при 403 нужно выдать права:  
`sudo chmod 755 /opt/arv/storage && sudo chmod -R a+rX /opt/arv/storage`

## 3. Путь к хранилищу на сервере

В `.env` на сервере должно быть:

```env
STORAGE_BASE_PATH=/opt/arv/storage
```

Каталог должен существовать, а файлы заказов лежать внутри, например:  
`/opt/arv/storage/VertexAR/portrety/ORD-20260211-1004/thumbnail.webp`, `qr_code.png`, `video.mp4`.

## 4. Перезапуск приложения и кэш браузера

После `git pull` перезапустите приложение:

```bash
sudo systemctl restart arv
```

В браузере сделайте жёсткое обновление страницы (Ctrl+Shift+R или «Очистить кэш и обновить»), чтобы подтянуть новый шаблон и скрипты.

## Итог

| Что не работает | Причина | Что сделать |
|-----------------|--------|--------------|
| Превью (фото/видео), QR не грузятся, 403 в консоли | Nginx отдаёт `/storage/` сам и нет прав / не проксирует на бэкенд | П. 2: конфиг Nginx с proxy_pass и reload |
| Пустые поля «Ссылка для AR-просмотра» и QR на странице детали | Старый шаблон без Alpine.store | П. 1 и 4: git pull, перезапуск, жёсткое обновление страницы |
| Превью есть в БД, но путь другой | Неверный STORAGE_BASE_PATH или файлы в другом месте | П. 3: проверить .env и каталог на диске |

После выполнения шагов 1–4 превью, ссылки и QR должны отображаться.

---

## Просмотр логов (почему в приложении «Повторить» и ссылка не открывается)

На сервере логи приложения:

```bash
# последние 200 строк
journalctl -u arv -n 200 --no-pager

# в реальном времени (откройте ссылку/сканируйте QR и смотрите вывод)
journalctl -u arv -f
```

Что искать:

| Сообщение в логах | Значение |
|-------------------|----------|
| `ar_viewer_landing_request` / `ar_viewer_landing_ok` | Открыли страницу `/view/{id}` в браузере — всё ок |
| `ar_viewer_error` или 404/403/500 | Ошибка страницы просмотра (контент не найден, истёк, не ready) |
| `viewer_check_ok` | Запрос приложения к `/api/viewer/ar/{id}/check` — контент доступен |
| `viewer_check_not_found` / `viewer_check_expired` / `viewer_check_no_video` | Приложение получило «контент недоступен» |
| `viewer_manifest_served` | Приложение запросило манифест и получило его (в логе будут `marker_image_url`, `video_url`) |

Если манифест отдаётся (`viewer_manifest_served`), но в приложении всё равно «Повторить» — приложение не может загрузить **файлы по URL** (маркер или видео). Тогда в логах сервера не будет ошибки; 403 отдаёт Nginx или приложение при запросе к `https://ar.neuroimagen.ru/storage/...`. Нужно устранить 403 по `/storage/` (п. 2 выше).

---

## Как проверить QR-код и ссылку

1. **Ссылка в браузере (с ПК или телефона)**  
   Откройте в браузере: `https://ar.neuroimagen.ru/view/{unique_id}`  
   (unique_id — UUID из админки, например `41209fae-0c89-42c2-bd4a-dd75b31b4f12`).  
   Должна открыться страница с кнопками «Открыть в приложении», «Скачать в Google Play». Если видите 404/403/500 — смотрите логи (см. выше).

2. **Проверка доступности контента для приложения**  
   В браузере или через curl:  
   `https://ar.neuroimagen.ru/api/viewer/ar/{unique_id}/check`  
   Ожидаемый ответ: `{"content_available": true}`.  
   Если `content_available: false` — в ответе будет `reason` (not_found, subscription_expired, no_playable_video и т.д.); в логах появятся `viewer_check_*`.

3. **Сканер QR в приложении**  
   QR должен содержать ссылку вида `https://ar.neuroimagen.ru/view/{unique_id}`.  
   - Если приложение открывается, но показывает «Повторить» — оно не может загрузить маркер или видео (чаще всего 403 на `/storage/...`). Исправьте раздачу `/storage/` (п. 2 в начале файла) и при необходимости права на файлы.  
   - После исправления перезапустите приложение на телефоне и отсканируйте QR снова.
