# Технологический стек проекта ARV

## Общее описание
Проект ARV (Augmented Reality Viewer) представляет собой веб-приложение для создания, управления и демонстрации AR-контента. Приложение позволяет пользователям загружать AR-модели, создавать проекты, настраивать параметры отображения AR-контента и делиться им с другими пользователями. Система поддерживает работу с AR-маркерами, предварительный просмотр контента, а также интеграцию с MindAR для отображения AR-контента в браузере.

Приложение реализовано на основе асинхронного фреймворка FastAPI с использованием SQLite в качестве основной базы данных для разработки и PostgreSQL на продакшене. Веб-интерфейс построен с использованием Jinja2 шаблонов, Tailwind CSS и Alpine.js, обеспечивая современный и отзывчивый пользовательский опыт. Для отображения AR-контента используется библиотека MindAR, позволяющая интегрировать AR-функциональность непосредственно в веб-браузер.

Система поддерживает аутентификацию пользователей, ролевую модель доступа, управление проектами и AR-контентом, а также предоставляет админ-панель для управления системой. Приложение также включает в себя функции уведомлений, настройки системы, логирования действий пользователей и мониторинга активности.

## Архитектура приложения
Приложение построено по принципам REST API с дополнительной поддержкой HTML-маршрутов через Jinja2 шаблоны. Используется разделение на уровни: API, модели, схемы, сервисы и HTML-маршруты.

## Технологический стек

### Backend (Бэкенд)
- **Язык программирования**: Python 3.11+
- **Веб-фреймворк**: FastAPI (асинхронный фреймворк для создания API)
- **ORM**: SQLAlchemy (объектно-реляционное отображение для работы с базой данных)
- **Миграции базы данных**: Alembic
- **Аутентификация**: OAuth2 с поддержкой JWT-токенов
- **Хеширование паролей**: bcrypt
- **Кэширование**: Redis
- **Фоновые задачи**: Celery или встроенные фоновые задачи FastAPI
- **Логирование**: стандартная библиотека logging
- **Конфигурация**: Pydantic Settings
- **Тестирование**: pytest
- **Валидация данных**: Pydantic
- **HTTP-клиент**: httpx
- **WSGI/ASGI сервер**: uvicorn

### Frontend (Фронтенд)
- **Шаблонизатор**: Jinja2
- **CSS Framework**: Tailwind CSS
- **JavaScript Framework**: Alpine.js
- **AR библиотека**: MindAR
- **JavaScript**: vanilla JS + HTMX для динамических частей интерфейса
- **AJAX**: для асинхронных запросов к API
- **WebSocket**: для реального времени (например, уведомления)
- **CSS препроцессор**: SCSS (через файлы стилей в проекте)
- **Иконки**: Font Awesome или Bootstrap Icons
- **HTML5**: для семантической разметки

### Database (База данных)
- **Разработка**: SQLite
- **Продакшен**: PostgreSQL 13+
- **Подключение**: через SQLAlchemy с использованием asyncpg драйвера для PostgreSQL
- **Миграции**: Alembic для управления изменениями схемы
- **Поддержка UUID**: встроенные UUID поля в моделях
- **Индексы**: оптимизация производительности запросов
- **Поддержка JSON**: для гибкого хранения метаданных

### API (API)
- **REST API**: стандартные CRUD операции для всех сущностей
- **Аутентификация**: OAuth2 password flow с JWT токенами
- **Документация API**: автоматически генерируемая Swagger UI и ReDoc
- **Валидация**: через Pydantic модели
- **Ограничение скорости**: middleware для предотвращения DDoS атак
- **WebSocket**: для реального времени (уведомления, чат и т.д.)
- **Фильтрация и пагинация**: через параметры запроса
- **CORS**: поддержка кросс-доменных запросов

## Структура проекта

```
app/
├── api/                 # API маршруты
│   ├── routes/          # Маршруты API
│   └── ar_content.py    # Маршруты AR-контента
├── html/                # HTML маршруты и шаблоны
│   ├── routes/          # HTML маршруты
│   └── filters.py       # Jinja2 фильтры
├── models/              # ORM модели
├── schemas/             # Pydantic схемы
├── services/            # Бизнес-логика
├── core/                # Конфигурация приложения
│   ├── config.py        # Настройки приложения
│   ├── database.py      # Настройки базы данных
│   └── security.py      # Настройки безопасности
├── middleware/          # Middleware компоненты
└── main.py              # Основной файл приложения

templates/               # HTML шаблоны
├── base.html            # Базовый шаблон
└── ar-content/          # Шаблоны AR-контента
    └── form.html

static/                  # Статические файлы (CSS, JS, изображения)
```

## Модели данных

### Основные сущности
- **User**: Пользователи системы с ролями и правами доступа
- **Company**: Компании, к которым принадлежат проекты
- **Project**: Проекты, содержащие AR-контент
- **ARContent**: AR-контент с метаданными, файлами и настройками
- **Notification**: Уведомления пользователям
- **Settings**: Системные настройки
- **Storage**: Информация о хранилище файлов
- **Video**: Видео материалы
- **Folder**: Папки для организации контента
- **AuditLog**: Журнал аудита действий пользователей

### Отношения между моделями
- User → Company (many-to-many через промежуточную таблицу)
- Company → Project (one-to-many)
- Project → ARContent (one-to-many)
- User → Notification (one-to-many)
- ARContent → Storage (one-to-one для файлов)

## API endpoints

### Аутентификация
- `POST /auth/token` - получение JWT токена
- `POST /auth/register` - регистрация нового пользователя
- `GET /auth/me` - получение информации о текущем пользователе
- `POST /auth/logout` - выход из системы

### Пользователи
- `GET /users/` - список пользователей
- `GET /users/{id}` - информация о конкретном пользователе
- `PUT /users/{id}` - обновление информации о пользователе
- `DELETE /users/{id}` - удаление пользователя

### Компании
- `GET /companies/` - список компаний
- `POST /companies/` - создание компании
- `GET /companies/{id}` - информация о компании
- `PUT /companies/{id}` - обновление компании
- `DELETE /companies/{id}` - удаление компании

### Проекты
- `GET /projects/` - список проектов (фильтрация по компании)
- `POST /projects/` - создание проекта
- `GET /projects/{id}` - информация о проекте
- `PUT /projects/{id}` - обновление проекта
- `DELETE /projects/{id}` - удаление проекта

### AR-контент
- `GET /ar-content/` - список AR-контента
- `POST /ar-content/` - создание AR-контента
- `GET /ar-content/{id}` - информация о AR-контенте
- `PUT /ar-content/{id}` - обновление AR-контента
- `DELETE /ar-content/{id}` - удаление AR-контента
- `POST /ar-content/upload/` - загрузка AR-файлов

### Уведомления
- `GET /notifications/` - список уведомлений
- `POST /notifications/` - создание уведомления
- `PUT /notifications/{id}/read` - пометить как прочитанное
- `DELETE /notifications/{id}` - удаление уведомления

## Безопасность

### Аутентификация и авторизация
- OAuth2 с JWT токенами
- Защита маршрутов через зависимости FastAPI
- Ролевая система доступа (администратор, пользователь)
- Хеширование паролей с помощью bcrypt

### Защита от атак
- CORS настройки
- Rate limiting (ограничение количества запросов)
- Валидация входных данных через Pydantic
- SQL-инъекции предотвращаются через ORM

## Файловое хранилище

### Поддерживаемые провайдеры
- Локальное хранилище
- AWS S3 (через boto3)
- Google Cloud Storage
- Azure Blob Storage

### Загрузка файлов
- Поддержка различных форматов AR-контента
- Валидация типов файлов
- Ограничение размера файлов
- Генерация уникальных имен файлов

## Кэширование и производительность

### Redis
- Кэширование частых запросов
- Сессии пользователей
- Ограничение скорости запросов
- Хранение временных данных

### Оптимизации
- Использование индексов в базе данных
- Пагинация результатов
- Lazy loading связанных объектов
- Асинхронные запросы к базе данных

## Тестирование

### Unit-тесты
- pytest для написания тестов
- Тестирование бизнес-логики
- Тестирование API эндпоинтов
- Тестирование моделей данных

### Интеграционные тесты
- Тестирование взаимодействия между компонентами
- Тестирование с использованием тестовой базы данных
- Тестирование аутентификации и авторизации

## Деплоймент

### Docker
- Контейнеризация приложения
- Отдельные образы для разработки и продакшена
- Multi-stage сборка

### CI/CD
- Автоматическая сборка и тестирование
- Развертывание на разных окружениях
- Мониторинг состояния приложения

## Административная панель

### Функциональность
- Управление пользователями
- Управление компаниями и проектами
- Мониторинг активности
- Настройка системных параметров
- Управление уведомлениями

### Доступ
- Только для пользователей с ролью администратора
- Защита через аутентификацию
- Логирование административных действий

## Мониторинг и логирование

### Логирование
- Структурированные логи
- Уровни логирования (DEBUG, INFO, WARNING, ERROR)
- Логирование HTTP запросов
- Логирование ошибок приложения

### Метрики
- Статистика использования
- Мониторинг производительности
- Отслеживание ошибок в реальном времени

## Расширяемость

### Микросервисы
- Возможность разделения на микросервисы
- Независимое масштабирование компонентов
- Асинхронная обработка задач

### Плагины
- Поддержка плагинов для расширения функциональности
- API для интеграции с внешними системами

## Документация API

### Swagger UI
- Интерактивная документация API
- Возможность тестирования эндпоинтов
- Примеры запросов и ответов

### ReDoc
- Альтернативный способ просмотра документации
- Более читабельный формат для разработчиков

## Особенности реализации
### Поддержка AR-контента
- Загрузка и хранение AR-файлов
- Генерация маркеров для AR
- Поддержка различных форматов AR
- Предварительный просмотр контента
- Интеграция с MindAR для отображения AR-контента в браузере


### Уведомления
- Real-time уведомления через WebSocket
- Поддержка различных типов уведомлений
- Возможность массовой рассылки
- История уведомлений

### Настройки системы
- Централизованное хранение настроек
- Возможность изменения через админ-панель
- Поддержка тем оформления
- Настройка безопасности

## Требования к окружению

### Минимальные требования
- Python 3.11+
- PostgreSQL 13+
- Redis 6+
- 2GB RAM (рекомендуется 4GB+)
- 10GB свободного места

### Зависимости (основные)
- fastapi==0.104.1
- sqlalchemy==2.0.23
- psycopg2-binary==2.9.9
- redis==5.0.1
- celery==5.3.4
- jinja2==3.1.2
- uvicorn==0.24.0
- pydantic==2.5.0
- python-multipart==0.0.6
- bcrypt==4.0.1
- python-jose[cryptography]==3.3.0
- passlib[bcrypt]==1.7.4

## Запуск приложения

### Локальный запуск
```bash
pip install -r requirements.txt
python -m uvicorn app.main:app --host 127.0.0.1 --port 800
```

### Запуск через Docker
```bash
docker-compose up -d
```

### Запуск тестов
```bash
pytest
```

## Миграции базы данных

### Применение миграций
```bash
alembic upgrade head
```

### Создание новой миграции
```bash
alembic revision --autogenerate -m "Описание изменений"
```

## Кастомные функции

### UUID генерация
- Использование UUID4 для уникальных идентификаторов
- Совместимость с различными СУБД
- Безопасная генерация уникальных ключей

### Обработка файлов
- Валидация MIME-типов
- Проверка размера файлов
- Безопасное сохранение файлов
- Генерация уникальных имен

### Поддержка тем
- Темная/светлая тема
- Сохранение предпочтений пользователя
- CSS переменные для переключения тем