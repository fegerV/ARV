# Система генерации превью (Thumbnails) для Vertex AR

## Обзор

Система генерации превью автоматически создает уменьшенные копии изображений и кадры из видеофайлов для отображения в интерфейсе администратора. Система работает асинхронно с использованием Celery для предотвращения блокировки основного потока приложения.

Система поддерживает различные типы хранилищ через абстрактный интерфейс провайдеров, что позволяет гибко настраивать место хранения миниатюр в зависимости от конфигурации клиента.

## Архитектура

### Компоненты системы

1. **Модели данных** (`app/models/`)
   - `Video` - содержит поле `thumbnail_url` для хранения URL превью видео
   - `ARContent` - содержит поле `thumbnail_url` для хранения URL превью изображения

2. **Схемы данных** (`app/schemas/`)
   - `Video` и `ARContent` схемы включают поля `thumbnail_url`

3. **Сервис генерации превью** (`app/services/thumbnail_service.py`)
   - `ThumbnailService` - основной сервис для генерации превью
   - Использует Pillow для обработки изображений
   - Использует FFmpeg для извлечения кадров из видео

4. **Задачи Celery** (`app/tasks/preview_tasks.py`)
   - `generate_video_thumbnail` - задача для генерации превью видео
   - `generate_image_thumbnail` - задача для генерации превью изображения

5. **Фабрика провайдеров** (`app/services/storage/factory.py`)
   - `get_provider` - фабричная функция для получения провайдера по конфигурации хранения компании

6. **API endpoints** (`app/api/routes/ar_content.py`)
   - Автоматический запуск задач генерации превью при загрузке контента

## Как это работает

### Генерация превью для изображений

1. При создании нового AR контента администратор загружает изображение
2. API endpoint вызывает задачу Celery `generate_image_thumbnail`
3. Задача:
   - Загружает исходное изображение
   - Создает уменьшенную копию размером 320x240 пикселей
   - Сохраняет превью в директорию `storage/content/thumbnails/`
   - Обновляет запись в базе данных с URL превью
   - Загружает превью в выбранное хранилище (при необходимости)

### Генерация превью для видео

1. При загрузке видеофайла API endpoint вызывает задачу Celery `generate_video_thumbnail`
2. Задача:
   - Использует FFmpeg для извлечения кадра на 1-й секунде видео
   - Создает уменьшенную копию извлеченного кадра
   - Сохраняет превью в директорию `storage/content/thumbnails/`
   - Обновляет запись в базе данных с URL превью
   - Загружает превью в выбранное хранилище (при необходимости)

## Конфигурация

### Параметры сервиса

В `ThumbnailService` можно настроить следующие параметры:

```python
class ThumbnailService:
    def __init__(self):
        self.thumbnail_size = (320, 240)  # Ширина x Высота
        self.quality = 85  # Качество JPEG
```

### Поддерживаемые форматы

#### Изображения
- JPEG/JPG
- PNG
- GIF
- BMP
- TIFF

#### Видео
- MP4
- AVI
- MOV
- MKV
- WMV

## Интеграция с хранилищем

Система поддерживает различные типы хранилищ через абстрактный интерфейс провайдеров:

1. **Локальное хранилище** - файлы хранятся на локальном диске
2. **MinIO** - объектное хранилище S3-совместимое
3. **Yandex Disk** - облачное хранилище через OAuth

### Провайдеры хранилища

Каждый провайдер реализует единый интерфейс `StorageProvider` с методами:
- `upload_file` - загрузка файла в хранилище
- `download_file` - скачивание файла из хранилища
- `file_exists` - проверка существования файла
- `delete_file` - удаление файла
- `get_file_url` - получение публичного URL файла

При генерации миниатюр система автоматически определяет провайдер на основе конфигурации компании и использует его для сохранения миниатюр.

## Обработка ошибок

Система включает в себя механизмы обработки следующих ошибок:

1. **Отсутствие исходных файлов** - проверка наличия файлов перед обработкой
2. **Ошибки генерации** - логирование и повторные попытки через Celery
3. **Ошибки хранилища** - graceful degradation к локальному хранилищу
4. **Ошибки сети** - экспоненциальная задержка между повторными попытками

## Мониторинг и логирование

Все операции логируются с использованием structlog:

- Начало генерации превью
- Успешное завершение
- Ошибки и исключения
- Время выполнения операций

### Метрики Prometheus

Система экспортирует следующие метрики в Prometheus:

1. **thumbnail_generation_total** - количество попыток генерации миниатюр, помечено типом (image/video) и статусом (success/failure)
2. **thumbnail_generation_duration_seconds** - время, затраченное на генерацию миниатюр, помечено типом
3. **thumbnail_upload_total** - количество загрузок миниатюр, помечено провайдером и статусом
4. **thumbnail_upload_duration_seconds** - время, затраченное на загрузку миниатюр, помечено провайдером
5. **thumbnail_task_execution_total** - количество выполнений задач Celery, помечено типом задачи и статусом
6. **thumbnail_task_execution_duration_seconds** - время выполнения задач Celery, помечено типом задачи

Эти метрики позволяют отслеживать производительность системы и выявлять проблемы.

## Тестирование

Для тестирования системы доступны следующие скрипты:

1. `test_thumbnail_system.py` - комплексный тест всех функций
2. `test_thumbnail_generation.py` - базовый тест генерации

### Unit-тесты

В каталоге `tests/unit/` находятся unit-тесты для отдельных компонентов системы:

1. `test_thumbnail_service.py` - тесты сервиса генерации миниатюр
2. `test_storage_providers.py` - тесты провайдеров хранилища
3. `test_storage_factory.py` - тесты фабрики провайдеров
4. `test_prometheus_metrics.py` - тесты метрик Prometheus

Тесты покрывают основные сценарии использования и обработку ошибок.

## Развертывание

### Зависимости

- Python 3.11+
- Pillow 9.0+
- FFmpeg 4.0+
- Celery 5.3+

### Docker

В Dockerfile уже установлены все необходимые зависимости:

```dockerfile
RUN apt-get update && apt-get install -y --no-install-recommends \
    # ... другие зависимости
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*
```

## Примеры использования

### Создание превью для изображения

```python
from app.services.thumbnail_service import thumbnail_service

# Без провайдера (сохранение в локальное хранилище)
result = await thumbnail_service.generate_image_thumbnail(
    image_path="/path/to/image.jpg",
    output_dir="storage/content/thumbnails",
    thumbnail_name="my_image_thumb.jpg"
)

if result["status"] == "ready":
    print(f"Превью создано: {result['thumbnail_url']}")

# С провайдером (загрузка в удаленное хранилище)
provider = get_provider(storage_connection)  # Получение провайдера из подключения
result = await thumbnail_service.generate_image_thumbnail(
    image_path="/path/to/image.jpg",
    thumbnail_name="my_image_thumb.jpg",
    provider=provider,
    company_id=123
)
```

### Создание превью для видео

```python
from app.services.thumbnail_service import thumbnail_service

# Без провайдера (сохранение в локальное хранилище)
result = await thumbnail_service.generate_video_thumbnail(
    video_path="/path/to/video.mp4",
    output_dir="storage/content/thumbnails",
    thumbnail_name="my_video_thumb.jpg",
    time_position=5.0  # Кадр на 5 секунде
)

if result["status"] == "ready":
    print(f"Превью создано: {result['thumbnail_url']}")

# С провайдером (загрузка в удаленное хранилище)
provider = get_provider(storage_connection)  # Получение провайдера из подключения
result = await thumbnail_service.generate_video_thumbnail(
    video_path="/path/to/video.mp4",
    thumbnail_name="my_video_thumb.jpg",
    time_position=5.0,
    provider=provider,
    company_id=123
)
```

## Расширение функциональности

### Добавление поддержки новых форматов

Для добавления поддержки новых форматов необходимо:

1. Убедиться, что Pillow/FFmpeg поддерживают формат
2. При необходимости установить дополнительные кодеки
3. Протестировать обработку формата

### Настройка размеров превью

Для изменения стандартных размеров превью:

1. Измените параметр `thumbnail_size` в `ThumbnailService`
2. При необходимости обновите миграции базы данных
3. Протестируйте отображение в интерфейсе

## Устранение неполадок

### Превью не создаются

1. Проверьте логи Celery worker
2. Убедитесь, что файлы существуют и доступны
3. Проверьте права доступа к директориям
4. Убедитесь, что FFmpeg установлен и доступен

### Превью создаются, но не отображаются

1. Проверьте URL в базе данных
2. Убедитесь, что файлы доступны по указанному пути
3. Проверьте настройки веб-сервера (Nginx)

### Ошибки при обработке видео

1. Проверьте, что FFmpeg установлен
2. Убедитесь, что видеофайл не поврежден
3. Проверьте кодеки видеофайла